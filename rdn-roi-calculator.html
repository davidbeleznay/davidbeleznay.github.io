<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RDN Water Conservation ROI Calculator & Rebate Application Helper | AI Forester</title>
  <meta name="description" content="Calculate water savings, ROI, and payback periods for RDN rebate programs. Prepare your complete Irrigation & Soil Improvements application with personalized financial analysis.">
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; background: #f0f5f3; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: linear-gradient(135deg, #2c5530, #3a7f42); color: white; padding: 60px 20px; text-align: center; margin-bottom: 40px; border-radius: 0 0 20px 20px; }
    h1 { font-size: 2.5em; margin-bottom: 10px; font-weight: 700; }
    .subtitle { font-size: 1.2em; opacity: 0.95; margin-bottom: 20px; }
    .badges { display: flex; gap: 20px; justify-content: center; margin-top: 20px; flex-wrap: wrap; }
    .badge { background: rgba(255,255,255,0.2); padding: 8px 16px; border-radius: 20px; font-size: 0.9em; }
    .roi-showcase { background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); border-left: 5px solid #e74c3c; }
    .roi-intro { background: #e8f5ea; border: 1px solid #c3e6cb; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
    .water-rates-info { background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 20px; margin-bottom: 25px; }
    .rate-tier { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #ffeaa7; }
    .tier-rate { color: #e74c3c; font-weight: bold; }
    .calculator-wrapper { background: white; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); padding: 40px; margin-bottom: 40px; }
    .progress-bar { display: flex; justify-content: space-between; margin-bottom: 40px; position: relative; }
    .progress-step { position: relative; z-index: 1; text-align: center; flex: 1; }
    .step-circle { width: 40px; height: 40px; border-radius: 50%; background: #e0e0e0; margin: 0 auto 10px; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; transition: all 0.3s ease; }
    .progress-step.active .step-circle, .progress-step.completed .step-circle { background: #3a7f42; }
    .form-section { display: none; }
    .form-section.active { display: block; }
    .form-group { margin-bottom: 25px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c5530; }
    input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; transition: border-color 0.3s ease; }
    input:focus, select:focus, textarea:focus { outline: none; border-color: #3a7f42; }
    .help-text { font-size: 0.85em; color: #666; margin-top: 5px; }
    .water-usage-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
    .usage-analysis { background: #e8f5ea; padding: 20px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #3a7f42; }
    .analysis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px; }
    .analysis-metric { background: white; padding: 15px; border-radius: 8px; text-align: center; }
    .metric-value { font-size: 1.4em; font-weight: bold; color: #2c5530; }
    .checkbox-group { display: flex; flex-direction: column; gap: 15px; }
    .checkbox-item { display: flex; align-items: start; padding: 15px; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
    .checkbox-item:hover { border-color: #3a7f42; background: #f9fdfb; }
    .upgrade-details { display: none; margin-top: 20px; padding: 20px; background: #f9fdfb; border-radius: 8px; border: 1px solid #e0f0e5; }
    .soil-calculator { background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 20px; border: 1px solid #b3d9ff; }
    .btn { padding: 14px 30px; border: none; border-radius: 8px; font-size: 1em; cursor: pointer; transition: all 0.3s ease; font-weight: 600; text-decoration: none; display: inline-block; text-align: center; }
    .btn-primary { background: #3a7f42; color: white; }
    .btn-primary:hover { background: #2c5530; transform: translateY(-1px); }
    .btn-secondary { background: #e0e0e0; color: #333; }
    .btn-success { background: #4CAF50; color: white; }
    .results-section { display: none; margin-top: 40px; }
    .results-section.active { display: block; }
    .roi-results { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .roi-card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s ease; }
    .roi-value { font-size: 2em; font-weight: bold; color: #3a7f42; margin: 10px 0; }
    .payback-table { width: 100%; border-collapse: collapse; margin-top: 15px; background: white; border-radius: 8px; overflow: hidden; }
    .payback-table th, .payback-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e0e0e0; }
    .application-preview { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 3px 10px rgba(0,0,0,0.1); margin-bottom: 30px; border: 2px solid #3a7f42; }
    .form-preview { background: #f8f9fa; padding: 20px; border-radius: 8px; font-family: monospace; font-size: 0.9em; white-space: pre-line; margin-bottom: 20px; }
    .environmental-impact { background: linear-gradient(135deg, #e8f5ea, #d4f1d9); padding: 30px; border-radius: 12px; margin-bottom: 30px; }
    .impact-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px; }
    .impact-item { background: rgba(255,255,255,0.8); padding: 20px; border-radius: 10px; text-align: center; }
    .impact-value { font-size: 1.8em; font-weight: bold; color: #2c5530; }
    .cta-section { background: linear-gradient(135deg, #3a7f42, #2c5530); color: white; padding: 40px; border-radius: 12px; text-align: center; margin-top: 40px; }
    @media (max-width: 768px) { .form-row, .water-usage-grid { grid-template-columns: 1fr; } .btn { width: 100%; } }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>RDN Water Conservation ROI Calculator</h1>
      <p class="subtitle">Complete Financial Analysis & Rebate Application Helper</p>
      <div class="badges">
        <span class="badge">💰 Up to $875 in Rebates</span>
        <span class="badge">📊 ROI & Payback Analysis</span>
        <span class="badge">📋 Form Pre-filled</span>
        <span class="badge">💧 Water Savings Calculator</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="roi-showcase">
      <h2>🎯 Complete Return on Investment Analysis</h2>
      <div class="roi-intro">
        <h3>What This ROI Calculator Does</h3>
        <p>✅ Analyzes your water consumption baseline using RDN seasonal patterns</p>
        <p>✅ Calculates potential water savings for each upgrade scenario</p>
        <p>✅ Applies Nanaimo's tiered water rates to determine actual cost savings</p>
        <p>✅ Computes payback periods based on net project costs after rebates</p>
        <p>✅ Provides 10-year financial projections and environmental impact</p>
      </div>
      
      <div class="water-rates-info">
        <h4>💰 Nanaimo Water Rates (2025) - Tiered Pricing Structure</h4>
        <div class="rate-tier"><span class="tier-name">Base Rate (Daily):</span><span class="tier-rate">$1.06/day</span></div>
        <div class="rate-tier"><span class="tier-name">Tier 1 (0-110 gal/day):</span><span class="tier-rate">$0.00223/gallon</span></div>
        <div class="rate-tier"><span class="tier-name">Tier 2 (110-220 gal/day):</span><span class="tier-rate">$0.00555/gallon</span></div>
        <div class="rate-tier"><span class="tier-name">Tier 3 (220-330 gal/day):</span><span class="tier-rate">$0.00971/gallon</span></div>
        <div class="rate-tier"><span class="tier-name">Tier 4 (330+ gal/day):</span><span class="tier-rate">$0.01703/gallon</span></div>
      </div>
    </div>

    <div class="calculator-wrapper">
      <div class="progress-bar">
        <div class="progress-step active" id="step1"><div class="step-circle">1</div><div class="step-label">Property & Contact</div></div>
        <div class="progress-step" id="step2"><div class="step-circle">2</div><div class="step-label">Water Usage Baseline</div></div>
        <div class="progress-step" id="step3"><div class="step-circle">3</div><div class="step-label">Select Upgrades</div></div>
        <div class="progress-step" id="step4"><div class="step-circle">4</div><div class="step-label">ROI Analysis</div></div>
      </div>

      <div class="form-section active" id="section1">
        <h2>Property Owner Information</h2>
        <div class="form-row">
          <div class="form-group"><label for="fullName">Full Name</label><input type="text" id="fullName" placeholder="John Smith"></div>
          <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="john@email.com"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="phoneMain">Phone (Main)</label><input type="tel" id="phoneMain" placeholder="250-555-0123"></div>
          <div class="form-group"><label for="phoneAlt">Phone (Alt)</label><input type="tel" id="phoneAlt" placeholder="250-555-0456"></div>
        </div>
        <div class="form-group"><label for="propertyAddress">Property Address</label><input type="text" id="propertyAddress" placeholder="123 Main Street"></div>
        <div class="form-row">
          <div class="form-group"><label for="city">City</label><input type="text" id="city" placeholder="Nanaimo"></div>
          <div class="form-group"><label for="postalCode">Postal Code</label><input type="text" id="postalCode" placeholder="V9S 1A1"></div>
        </div>
        <button class="btn btn-primary" onclick="nextStep(1)" style="float:right;">Next: Water Usage →</button>
      </div>

      <div class="form-section" id="section2">
        <h2>Water Usage Baseline</h2>
        <div class="form-group"><label for="irrigatedArea">Irrigated Area (sq ft)</label><input type="number" id="irrigatedArea" placeholder="2000" onchange="updateUsageAnalysis()"></div>
        <div class="form-group"><label for="irrigationMonths">Irrigation Months/Year</label><input type="number" id="irrigationMonths" placeholder="6" onchange="updateUsageAnalysis()"></div>
        <h3>Water Bills (Optional)</h3>
        <div class="water-usage-grid">
          <div><label for="usage1">Winter 2024-25</label><input type="number" id="usage1" placeholder="8,000" onchange="updateUsageAnalysis()"></div>
          <div><label for="usage2">Fall 2024</label><input type="number" id="usage2" placeholder="12,000" onchange="updateUsageAnalysis()"></div>
          <div><label for="usage3">Summer 2024</label><input type="number" id="usage3" placeholder="20,000" onchange="updateUsageAnalysis()"></div>
          <div><label for="usage4">Spring 2024</label><input type="number" id="usage4" placeholder="15,000" onchange="updateUsageAnalysis()"></div>
        </div>
        <div class="usage-analysis" id="usageAnalysis" style="display:none;">
          <h4>📊 Water Analysis</h4>
          <div class="analysis-grid">
            <div class="analysis-metric"><div class="metric-value" id="avgDailyUsage">0</div><div>Daily Usage</div></div>
            <div class="analysis-metric"><div class="metric-value" id="currentTier">Tier 1</div><div>Rate Tier</div></div>
            <div class="analysis-metric"><div class="metric-value" id="annualCost">$0</div><div>Annual Cost</div></div>
            <div class="analysis-metric"><div class="metric-value" id="savingsPotential">High</div><div>Savings Potential</div></div>
          </div>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:30px;">
          <button class="btn btn-secondary" onclick="previousStep(2)">← Back</button>
          <button class="btn btn-primary" onclick="nextStep(2)">Next: Upgrades →</button>
        </div>
      </div>

      <div class="form-section" id="section3">
        <h2>Select Upgrades</h2>
        <div class="checkbox-group">
          <div class="checkbox-item"><input type="checkbox" id="rainSensor" value="rainSensor" onchange="toggleUpgradeDetails(this.value)"><div><strong>Rain Sensor ($75 rebate)</strong><br>10-15% water savings</div></div>
          <div class="checkbox-item"><input type="checkbox" id="smartController" value="smartController" onchange="toggleUpgradeDetails(this.value)"><div><strong>Smart Controller ($100 rebate)</strong><br>20-40% water savings</div></div>
          <div class="checkbox-item"><input type="checkbox" id="dripConversion" value="dripConversion" onchange="toggleUpgradeDetails(this.value)"><div><strong>Drip Irrigation ($400 rebate)</strong><br>30-50% water savings</div></div>
          <div class="checkbox-item"><input type="checkbox" id="mpRotators" value="mpRotators" onchange="toggleUpgradeDetails(this.value)"><div><strong>MP Rotators ($100 rebate)</strong><br>20-30% water savings</div></div>
          <div class="checkbox-item"><input type="checkbox" id="soilImprovements" value="soilImprovements" onchange="toggleUpgradeDetails(this.value)"><div><strong>Soil Improvements (50% up to $100)</strong><br>25% less watering needed</div></div>
        </div>
        
        <div class="upgrade-details" id="rainSensorDetails"><h3>Rain Sensor</h3><div class="form-row"><div><label for="rainSensorCost">Cost ($)</label><input type="number" id="rainSensorCost" value="100"></div><div><label for="rainSensorSavings">Savings (%)</label><input type="number" id="rainSensorSavings" value="15"></div></div></div>
        
        <div class="upgrade-details" id="smartControllerDetails"><h3>Smart Controller</h3><div class="form-row"><div><label for="controllerCost">Cost ($)</label><input type="number" id="controllerCost" value="250"></div><div><label for="controllerSavings">Savings (%)</label><input type="number" id="controllerSavings" value="30"></div></div></div>
        
        <div class="upgrade-details" id="dripConversionDetails"><h3>Drip Irrigation</h3><div class="form-row"><div><label for="dripArea">Area (sq ft)</label><input type="number" id="dripArea" placeholder="1000"></div><div><label for="dripCost">Cost ($)</label><input type="number" id="dripCost" value="800"></div></div><div><label for="dripSavings">Savings (%)</label><input type="number" id="dripSavings" value="40"></div><div><label for="irrigationDescription">Description</label><textarea id="irrigationDescription" placeholder="Describe irrigation upgrades"></textarea></div></div>
        
        <div class="upgrade-details" id="mpRotatorsDetails"><h3>MP Rotators</h3><div class="form-row"><div><label for="rotatorCost">Cost ($)</label><input type="number" id="rotatorCost" value="200"></div><div><label for="rotatorSavings">Savings (%)</label><input type="number" id="rotatorSavings" value="25"></div></div></div>
        
        <div class="upgrade-details" id="soilImprovementsDetails"><h3>Soil Improvements</h3><div class="form-row"><div><label for="applicationArea">Area (sq ft)</label><input type="number" id="applicationArea" placeholder="500" onchange="calculateSoilAmounts()"></div><div><label for="applicationDepth">Type</label><select id="applicationDepth" onchange="calculateSoilAmounts()"><option value="">Select type</option><option value="garden">Garden Beds (2 inch)</option><option value="lawn">Lawn Topdressing (1/4 inch)</option></select></div></div><div><label for="soilCost">Cost ($)</label><input type="number" id="soilCost" value="200"></div><div class="soil-calculator" id="soilCalculator" style="display:none;"><h4>Required Soil</h4><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:15px;"><div style="text-align:center;"><div id="bagsNeeded">0 bags</div><div>28L Bags</div></div><div style="text-align:center;"><div id="cubicYards">0 yards</div><div>Bulk</div></div><div style="text-align:center;"><div id="estimatedSoilCost">$0</div><div>Est. Cost</div></div></div></div><div><label for="soilDescription">Description</label><textarea id="soilDescription" placeholder="Describe soil improvements"></textarea></div></div>
        
        <div style="display:flex;justify-content:space-between;margin-top:30px;">
          <button class="btn btn-secondary" onclick="previousStep(3)">← Back</button>
          <button class="btn btn-success" onclick="calculateROI()">Calculate ROI →</button>
        </div>
      </div>
    </div>

    <div class="results-section" id="resultsSection">
      <h2>📊 ROI Analysis Results</h2>
      <div class="roi-results">
        <div class="roi-card"><div>💧</div><div class="roi-value" id="waterSavings">0</div><div>Gallons Saved/Year</div></div>
        <div class="roi-card"><div>💰</div><div class="roi-value" id="costSavings">$0</div><div>Annual Savings</div></div>
        <div class="roi-card"><div>🎯</div><div class="roi-value" id="totalRebates">$0</div><div>Total Rebates</div></div>
        <div class="roi-card"><div>📅</div><div class="roi-value" id="paybackPeriod">0</div><div>Payback Period</div></div>
        <div class="roi-card"><div>📈</div><div class="roi-value" id="roiPercentage">0%</div><div>5-Year ROI</div></div>
        <div class="roi-card"><div>🏠</div><div class="roi-value" id="propertyValue">+$0</div><div>Property Value</div></div>
      </div>
      
      <div style="background:#fff3cd;padding:25px;border-radius:12px;margin-bottom:30px;">
        <h3>💡 Financial Breakdown</h3>
        <table class="payback-table">
          <thead><tr><th>Upgrade</th><th>Cost</th><th>Rebate</th><th>Net Cost</th><th>Annual Savings</th><th>Payback</th></tr></thead>
          <tbody id="paybackTableBody"></tbody>
        </table>
      </div>
      
      <div class="environmental-impact">
        <h3>🌍 Environmental Impact (10-Year)</h3>
        <div class="impact-grid">
          <div class="impact-item"><div class="impact-value" id="lifetimeWaterSavings">0</div><div>Gallons Saved</div></div>
          <div class="impact-item"><div class="impact-value" id="waterReduction">0%</div><div>Water Reduction</div></div>
          <div class="impact-item"><div class="impact-value" id="co2Savings">0</div><div>lbs CO₂ Saved/Year</div></div>
          <div class="impact-item"><div class="impact-value" id="lifetimeSavings">$0</div><div>10-Year Savings</div></div>
        </div>
      </div>
      
      <div class="application-preview">
        <h3>📋 Pre-filled Application</h3>
        <div class="form-preview" id="applicationPreview"></div>
        <div style="background:#d1ecf1;padding:20px;border-radius:8px;"><h4>📋 Checklist</h4><div id="submissionChecklist"></div></div>
      </div>
      
      <div class="cta-section">
        <h2>Investment Plan Ready!</h2>
        <p>Complete ROI analysis shows strong returns. Download and start saving!</p>
        <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
          <button class="btn btn-primary" id="downloadApplication">📄 Download Analysis (PDF)</button>
          <a href="https://www.rdn.bc.ca/sites/default/files/inline-files/2025%20I%26S%20Pre-approval%20Application%20Form.pdf" target="_blank" class="btn btn-secondary">📋 Official Form</a>
          <button class="btn btn-secondary" onclick="location.reload()">🔄 New Analysis</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentStep = 1, formData = {}, selectedRebates = [], waterBaseline = {}, roiResults = {};
    const waterRates = { baseRate: 1.06, tiers: [{ min: 0, max: 110, rate: 0.00223 }, { min: 110, max: 220, rate: 0.00555 }, { min: 220, max: 330, rate: 0.00971 }, { min: 330, max: Infinity, rate: 0.01703 }] };
    
    function nextStep(step) {
      if (!validateStep(step)) return;
      if (step === 2) updateUsageAnalysis();
      document.getElementById(`step${step}`).classList.add('completed');
      document.getElementById(`step${step + 1}`).classList.add('active');
      document.getElementById(`section${step}`).classList.remove('active');
      document.getElementById(`section${step + 1}`).classList.add('active');
      currentStep = step + 1;
    }
    
    function previousStep(step) {
      document.getElementById(`step${step}`).classList.remove('active');
      document.getElementById(`step${step - 1}`).classList.remove('completed');
      document.getElementById(`section${step}`).classList.remove('active');
      document.getElementById(`section${step - 1}`).classList.add('active');
      currentStep = step - 1;
    }
    
    function validateStep(step) {
      if (step === 1) {
        const required = ['fullName', 'email', 'phoneMain', 'propertyAddress', 'city', 'postalCode'];
        for (let field of required) {
          if (!document.getElementById(field).value.trim()) {
            alert(`Please fill in ${field}`);
            return false;
          }
        }
      }
      if (step === 2) {
        if (!document.getElementById('irrigatedArea').value || !document.getElementById('irrigationMonths').value) {
          alert('Please fill in irrigation area and months');
          return false;
        }
      }
      if (step === 3) {
        if (document.querySelectorAll('input[type="checkbox"]:checked').length === 0) {
          alert('Please select at least one upgrade');
          return false;
        }
      }
      return true;
    }
    
    function updateUsageAnalysis() {
      const area = parseFloat(document.getElementById('irrigatedArea').value) || 0;
      const months = parseFloat(document.getElementById('irrigationMonths').value) || 6;
      const usageInputs = [parseFloat(document.getElementById('usage1').value) || 0, parseFloat(document.getElementById('usage2').value) || 0, parseFloat(document.getElementById('usage3').value) || 0, parseFloat(document.getElementById('usage4').value) || 0];
      const hasActualData = usageInputs.some(u => u > 0);
      
      let avgDailyUsage, outdoorPercentage, currentTier, annualCost;
      
      if (hasActualData) {
        const totalUsage = usageInputs.reduce((sum, usage) => sum + usage, 0);
        const periodsWithData = usageInputs.filter(u => u > 0).length;
        avgDailyUsage = Math.round((totalUsage / periodsWithData) / 90);
        const summerUsage = usageInputs[2] || avgDailyUsage * 90;
        const winterUsage = usageInputs[0] || avgDailyUsage * 90;
        const seasonalIncrease = summerUsage - winterUsage;
        outdoorPercentage = seasonalIncrease > 0 ? Math.round((seasonalIncrease / summerUsage) * 100) : 30;
      } else {
        const baseIndoor = 60;
        const outdoorRate = area * 0.03 * (months / 12);
        avgDailyUsage = Math.round(baseIndoor + outdoorRate);
        outdoorPercentage = Math.round((outdoorRate / avgDailyUsage) * 100);
      }
      
      currentTier = avgDailyUsage > 330 ? 'Tier 4' : avgDailyUsage > 220 ? 'Tier 3' : avgDailyUsage > 110 ? 'Tier 2' : 'Tier 1';
      annualCost = calculateWaterCost(avgDailyUsage * 365);
      let potential = avgDailyUsage > 150 ? 'Very High' : avgDailyUsage > 100 ? 'High' : avgDailyUsage < 60 ? 'Limited' : 'Moderate';
      
      document.getElementById('avgDailyUsage').textContent = `${avgDailyUsage} gal/day`;
      document.getElementById('currentTier').textContent = currentTier;
      document.getElementById('annualCost').textContent = `$${Math.round(annualCost)}`;
      document.getElementById('savingsPotential').textContent = potential;
      
      waterBaseline = { dailyUsage: avgDailyUsage, annualUsage: avgDailyUsage * 365, outdoorPortion: outdoorPercentage / 100, currentTier, annualCost, irrigatedArea: area, irrigationMonths: months };
      document.getElementById('usageAnalysis').style.display = 'block';
    }
    
    function calculateWaterCost(annualGallons) {
      const dailyGallons = annualGallons / 365;
      let totalCost = waterRates.baseRate * 365;
      for (let tier of waterRates.tiers) {
        if (dailyGallons > tier.min) {
          const tierUsage = Math.min(dailyGallons, tier.max) - tier.min;
          totalCost += tierUsage * tier.rate * 365;
        }
      }
      return totalCost;
    }
    
    function toggleUpgradeDetails(upgrade) {
      selectedRebates = Array.from(document.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
      const details = document.getElementById(upgrade + 'Details');
      const checkbox = document.getElementById(upgrade);
      details.style.display = checkbox.checked ? 'block' : 'none';
    }
    
    function calculateSoilAmounts() {
      const area = parseFloat(document.getElementById('applicationArea').value) || 0;
      const depthType = document.getElementById('applicationDepth').value;
      if (!area || !depthType) return;
      
      let bags, cubicYards, minCost, maxCost;
      if (depthType === 'garden') {
        bags = Math.ceil((area / 400) * 67);
        cubicYards = (area / 400) * 2.4;
      } else {
        bags = Math.ceil((area / 400) * 10);
        cubicYards = (area / 400) * 0.32;
      }
      minCost = bags * 8; maxCost = bags * 12;
      
      document.getElementById('bagsNeeded').textContent = `${bags} bags`;
      document.getElementById('cubicYards').textContent = `${cubicYards.toFixed(1)} yards`;
      document.getElementById('estimatedSoilCost').textContent = `$${minCost}-$${maxCost}`;
      document.getElementById('soilCalculator').style.display = 'block';
      document.getElementById('soilCost').value = Math.round((minCost + maxCost) / 2);
    }
    
    function calculateROI() {
      collectFormData();
      roiResults = { upgrades: [], totalCost: 0, totalRebates: 0, totalWaterSavings: 0, totalCostSavings: 0, netCost: 0, paybackYears: 0, roiPercentage: 0, environmentalImpact: {} };
      
      const baselineUsage = waterBaseline.annualUsage;
      const outdoorUsage = baselineUsage * waterBaseline.outdoorPortion;
      
      selectedRebates.forEach(rebate => {
        const upgrade = calculateUpgradeROI(rebate, outdoorUsage);
        roiResults.upgrades.push(upgrade);
        roiResults.totalCost += upgrade.cost;
        roiResults.totalRebates += upgrade.rebate;
        roiResults.totalWaterSavings += upgrade.waterSavings;
      });
      
      const currentAnnualCost = calculateWaterCost(baselineUsage);
      const newAnnualCost = calculateWaterCost(baselineUsage - roiResults.totalWaterSavings);
      roiResults.totalCostSavings = currentAnnualCost - newAnnualCost;
      roiResults.netCost = roiResults.totalCost - roiResults.totalRebates;
      roiResults.paybackYears = roiResults.totalCostSavings > 0 ? roiResults.netCost / roiResults.totalCostSavings : 999;
      roiResults.roiPercentage = roiResults.netCost > 0 ? ((roiResults.totalCostSavings * 5 - roiResults.netCost) / roiResults.netCost) * 100 : 0;
      
      roiResults.environmentalImpact = {
        lifetimeWaterSavings: roiResults.totalWaterSavings * 10,
        waterReduction: Math.round((roiResults.totalWaterSavings / baselineUsage) * 100),
        co2Savings: Math.round(roiResults.totalWaterSavings * 0.006),
        lifetimeCostSavings: roiResults.totalCostSavings * 10,
        propertyValueIncrease: Math.round(roiResults.totalWaterSavings * 0.5)
      };
      
      displayResults();
      generateApplication();
    }
    
    function calculateUpgradeROI(upgradeType, outdoorUsage) {
      let cost = 0, rebate = 0, waterSavings = 0, savingsPercent = 0;
      
      switch (upgradeType) {
        case 'rainSensor':
          cost = parseFloat(document.getElementById('rainSensorCost').value) || 100;
          rebate = 75;
          savingsPercent = parseFloat(document.getElementById('rainSensorSavings').value) || 15;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
        case 'smartController':
          cost = parseFloat(document.getElementById('controllerCost').value) || 250;
          rebate = 100;
          savingsPercent = parseFloat(document.getElementById('controllerSavings').value) || 30;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
        case 'dripConversion':
          cost = parseFloat(document.getElementById('dripCost').value) || 800;
          rebate = 400;
          const dripArea = parseFloat(document.getElementById('dripArea').value) || waterBaseline.irrigatedArea;
          const areaFraction = dripArea / waterBaseline.irrigatedArea;
          savingsPercent = parseFloat(document.getElementById('dripSavings').value) || 40;
          waterSavings = outdoorUsage * areaFraction * (savingsPercent / 100);
          break;
        case 'mpRotators':
          cost = parseFloat(document.getElementById('rotatorCost').value) || 200;
          rebate = 100;
          savingsPercent = parseFloat(document.getElementById('rotatorSavings').value) || 25;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
        case 'soilImprovements':
          cost = parseFloat(document.getElementById('soilCost').value) || 200;
          rebate = Math.min(cost * 0.5, 100);
          savingsPercent = parseFloat(document.getElementById('soilSavings').value) || 25;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
      }
      
      return { type: upgradeType, cost, rebate, waterSavings, savingsPercent, netCost: cost - rebate };
    }
    
    function displayResults() {
      document.getElementById('waterSavings').textContent = Math.round(roiResults.totalWaterSavings).toLocaleString();
      document.getElementById('costSavings').textContent = `$${Math.round(roiResults.totalCostSavings)}`;
      document.getElementById('totalRebates').textContent = `$${roiResults.totalRebates}`;
      document.getElementById('paybackPeriod').textContent = roiResults.paybackYears < 20 ? `${roiResults.paybackYears.toFixed(1)} years` : '20+ years';
      document.getElementById('roiPercentage').textContent = `${Math.round(roiResults.roiPercentage)}%`;
      document.getElementById('propertyValue').textContent = `+$${roiResults.environmentalImpact.propertyValueIncrease}`;
      
      document.getElementById('lifetimeWaterSavings').textContent = Math.round(roiResults.environmentalImpact.lifetimeWaterSavings).toLocaleString();
      document.getElementById('waterReduction').textContent = `${roiResults.environmentalImpact.waterReduction}%`;
      document.getElementById('co2Savings').textContent = roiResults.environmentalImpact.co2Savings;
      document.getElementById('lifetimeSavings').textContent = `$${Math.round(roiResults.environmentalImpact.lifetimeCostSavings).toLocaleString()}`;
      
      const tableBody = document.getElementById('paybackTableBody');
      tableBody.innerHTML = '';
      
      roiResults.upgrades.forEach(upgrade => {
        const row = tableBody.insertRow();
        const upgradeName = getUpgradeName(upgrade.type);
        const payback = upgrade.netCost > 0 && roiResults.totalCostSavings > 0 ? (upgrade.netCost / (roiResults.totalCostSavings * (upgrade.waterSavings / roiResults.totalWaterSavings))).toFixed(1) + ' years' : 'N/A';
        row.innerHTML = `<td>${upgradeName}</td><td>$${upgrade.cost}</td><td>$${upgrade.rebate}</td><td>$${upgrade.netCost}</td><td>$${Math.round((roiResults.totalCostSavings * (upgrade.waterSavings / roiResults.totalWaterSavings)))}</td><td>${payback}</td>`;
      });
      
      const totalRow = tableBody.insertRow();
      totalRow.style.background = '#e8f5ea';
      totalRow.style.fontWeight = 'bold';
      totalRow.innerHTML = `<td>TOTALS</td><td>$${roiResults.totalCost}</td><td>$${roiResults.totalRebates}</td><td>$${roiResults.netCost}</td><td>$${Math.round(roiResults.totalCostSavings)}</td><td>${roiResults.paybackYears < 20 ? roiResults.paybackYears.toFixed(1) + ' years' : '20+ years'}</td>`;
      
      document.getElementById('resultsSection').classList.add('active');
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function getUpgradeName(type) {
      const names = { 'rainSensor': 'Rain Sensor', 'smartController': 'Smart Controller', 'dripConversion': 'Drip Irrigation', 'mpRotators': 'MP Rotators', 'soilImprovements': 'Soil Improvements' };
      return names[type] || type;
    }
    
    function collectFormData() {
      formData = {
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phoneMain: document.getElementById('phoneMain').value,
        phoneAlt: document.getElementById('phoneAlt').value || 'N/A',
        propertyAddress: document.getElementById('propertyAddress').value,
        city: document.getElementById('city').value,
        postalCode: document.getElementById('postalCode').value,
        irrigatedArea: document.getElementById('irrigatedArea').value,
        irrigationMonths: document.getElementById('irrigationMonths').value,
        irrigationDescription: document.getElementById('irrigationDescription')?.value || '',
        soilDescription: document.getElementById('soilDescription')?.value || ''
      };
    }
    
    function generateApplication() {
      const today = new Date().toLocaleDateString('en-CA');
      let selectedUpgrades = '';
      roiResults.upgrades.forEach(upgrade => {
        selectedUpgrades += `• ${getUpgradeName(upgrade.type)} - Cost: $${upgrade.cost}, Rebate: $${upgrade.rebate}\n`;
      });
      
      const applicationText = `RDN IRRIGATION & SOIL IMPROVEMENTS APPLICATION\nGenerated: ${today}\n\nAPPLICANT:\nName: ${formData.fullName}\nEmail: ${formData.email}\nPhone: ${formData.phoneMain}\nAddress: ${formData.propertyAddress}, ${formData.city} ${formData.postalCode}\n\nPROPERTY:\nIrrigated Area: ${formData.irrigatedArea} sq ft\nIrrigation Season: ${formData.irrigationMonths} months\nCurrent Usage: ${Math.round(waterBaseline.dailyUsage)} gal/day\n\nUPGRADES:\n${selectedUpgrades}\nTotal Cost: $${roiResults.totalCost}\nTotal Rebates: $${roiResults.totalRebates}\nNet Cost: $${roiResults.netCost}\n\nPROJECTED BENEFITS:\nAnnual Water Savings: ${Math.round(roiResults.totalWaterSavings).toLocaleString()} gallons\nAnnual Cost Savings: $${Math.round(roiResults.totalCostSavings)}\nPayback: ${roiResults.paybackYears < 20 ? roiResults.paybackYears.toFixed(1) + ' years' : '20+ years'}\n5-Year ROI: ${Math.round(roiResults.roiPercentage)}%\n\nDeclaration: Work must be completed by December 15, 2025.\nSignature: _________________________ Date: _____________`;
      
      document.getElementById('applicationPreview').textContent = applicationText;
      
      const checklist = ['Review application', 'Get contractor quotes', 'Take before photos', 'Submit for pre-approval', 'Complete work by Dec 15, 2025', 'Take after photos', 'Submit receipts', 'Allow 6-8 weeks processing'];
      document.getElementById('submissionChecklist').innerHTML = checklist.map(item => `<div style="margin:5px 0;">☐ ${item}</div>`).join('');
      
      setupPDFDownload(applicationText);
    }
    
    function setupPDFDownload(applicationText) {
      document.getElementById('downloadApplication').onclick = function() {
        if (typeof window.jsPDF === 'undefined') {
          alert('PDF not available. Copy text manually.');
          return;
        }
        const { jsPDF } = window.jsPDF;
        const doc = new jsPDF();
        doc.setFontSize(16);
        doc.text('RDN Water Conservation ROI Analysis', 20, 20);
        doc.setFontSize(10);
        const lines = applicationText.split('\n');
        let y = 40;
        lines.forEach(line => {
          if (y > 270) { doc.addPage(); y = 20; }
          doc.text(line, 20, y);
          y += 6;
        });
        doc.save(`RDN_ROI_Analysis_${formData.fullName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`);
      };
    }
    
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('irrigationMonths').value = '6';
      document.getElementById('city').value = 'Nanaimo';
    });
  </script>
</body>
</html>