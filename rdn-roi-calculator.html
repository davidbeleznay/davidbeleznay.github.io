          savingsPercent = parseFloat(document.getElementById('dripSavings').value) || 40;
          waterSavings = outdoorUsage * areaFraction * (savingsPercent / 100);
          break;
          
        case 'mpRotators':
          cost = parseFloat(document.getElementById('rotatorCost').value) || 200;
          rebate = 100;
          savingsPercent = parseFloat(document.getElementById('rotatorSavings').value) || 25;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
          
        case 'soilImprovements':
          cost = parseFloat(document.getElementById('soilCost').value) || 200;
          rebate = Math.min(cost * 0.5, 100); // 50% up to $100
          savingsPercent = parseFloat(document.getElementById('soilSavings').value) || 25;
          waterSavings = outdoorUsage * (savingsPercent / 100);
          break;
      }
      
      return {
        type: upgradeType,
        cost: cost,
        rebate: rebate,
        waterSavings: waterSavings,
        savingsPercent: savingsPercent,
        netCost: cost - rebate
      };
    }
    
    function displayResults() {
      // Update ROI cards
      document.getElementById('waterSavings').textContent = Math.round(roiResults.totalWaterSavings).toLocaleString();
      document.getElementById('costSavings').textContent = `$${Math.round(roiResults.totalCostSavings)}`;
      document.getElementById('totalRebates').textContent = `$${roiResults.totalRebates}`;
      document.getElementById('paybackPeriod').textContent = roiResults.paybackYears < 20 ? 
        `${roiResults.paybackYears.toFixed(1)} years` : '20+ years';
      document.getElementById('roiPercentage').textContent = `${Math.round(roiResults.roiPercentage)}%`;
      document.getElementById('propertyValue').textContent = `+$${roiResults.environmentalImpact.propertyValueIncrease}`;
      
      // Update environmental impact
      document.getElementById('lifetimeWaterSavings').textContent = 
        Math.round(roiResults.environmentalImpact.lifetimeWaterSavings).toLocaleString();
      document.getElementById('waterReduction').textContent = `${roiResults.environmentalImpact.waterReduction}%`;
      document.getElementById('co2Savings').textContent = roiResults.environmentalImpact.co2Savings;
      document.getElementById('lifetimeSavings').textContent = 
        `$${Math.round(roiResults.environmentalImpact.lifetimeCostSavings).toLocaleString()}`;
      
      // Populate payback table
      const tableBody = document.getElementById('paybackTableBody');
      tableBody.innerHTML = '';
      
      roiResults.upgrades.forEach(upgrade => {
        const row = tableBody.insertRow();
        const upgradeName = getUpgradeName(upgrade.type);
        const payback = upgrade.netCost > 0 && roiResults.totalCostSavings > 0 ? 
          (upgrade.netCost / (roiResults.totalCostSavings * (upgrade.waterSavings / roiResults.totalWaterSavings))).toFixed(1) + ' years' : 
          'N/A';
        
        row.innerHTML = `
          <td>${upgradeName}</td>
          <td>$${upgrade.cost}</td>
          <td>$${upgrade.rebate}</td>
          <td>$${upgrade.netCost}</td>
          <td>$${Math.round((roiResults.totalCostSavings * (upgrade.waterSavings / roiResults.totalWaterSavings)))}</td>
          <td>${payback}</td>
        `;
      });
      
      // Add combo bonus row if applicable
      if (selectedRebates.includes('comboBonus')) {
        const row = tableBody.insertRow();
        row.innerHTML = `
          <td>Combo Bonus</td>
          <td>$0</td>
          <td>$100</td>
          <td>-$100</td>
          <td>$0</td>
          <td>Instant</td>
        `;
      }
      
      // Add totals row
      const totalRow = tableBody.insertRow();
      totalRow.className = 'total-row';
      totalRow.innerHTML = `
        <td><strong>TOTALS</strong></td>
        <td><strong>$${roiResults.totalCost}</strong></td>
        <td><strong>$${roiResults.totalRebates}</strong></td>
        <td><strong>$${roiResults.netCost}</strong></td>
        <td><strong>$${Math.round(roiResults.totalCostSavings)}</strong></td>
        <td><strong>${roiResults.paybackYears < 20 ? roiResults.paybackYears.toFixed(1) + ' years' : '20+ years'}</strong></td>
      `;
      
      // Show results section
      document.getElementById('resultsSection').classList.add('active');
      document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
    }
    
    function getUpgradeName(type) {
      const names = {
        'rainSensor': 'Rain Sensor',
        'smartController': 'Smart Controller',
        'dripConversion': 'Drip Irrigation',
        'mpRotators': 'MP Rotator Nozzles',
        'soilImprovements': 'Soil Improvements'
      };
      return names[type] || type;
    }
    
    function collectFormData() {
      formData = {
        // Personal Info
        fullName: document.getElementById('fullName').value,
        email: document.getElementById('email').value,
        phoneMain: document.getElementById('phoneMain').value,
        phoneAlt: document.getElementById('phoneAlt').value || 'N/A',
        propertyAddress: document.getElementById('propertyAddress').value,
        city: document.getElementById('city').value,
        postalCode: document.getElementById('postalCode').value,
        mailingAddress: document.getElementById('mailingAddress').value || 'Same as property address',
        
        // Property Details
        irrigatedArea: document.getElementById('irrigatedArea').value,
        irrigationMonths: document.getElementById('irrigationMonths').value,
        
        // Usage Data
        usage1: document.getElementById('usage1').value,
        usage2: document.getElementById('usage2').value,
        usage3: document.getElementById('usage3').value,
        usage4: document.getElementById('usage4').value,
        
        // Upgrade specific details
        irrigationDescription: document.getElementById('irrigationDescription')?.value || '',
        soilDescription: document.getElementById('soilDescription')?.value || '',
        applicationArea: document.getElementById('applicationArea')?.value || '',
        dripArea: document.getElementById('dripArea')?.value || ''
      };
    }
    
    function generateApplication() {
      const today = new Date();
      const formattedDate = today.toLocaleDateString('en-CA'); // YYYY-MM-DD format
      
      let selectedUpgrades = '';
      let totalProjectCost = 0;
      let totalRebateAmount = 0;
      
      // Build upgrade descriptions
      roiResults.upgrades.forEach(upgrade => {
        const name = getUpgradeName(upgrade.type);
        selectedUpgrades += `• ${name} - Cost: $${upgrade.cost}, Rebate: $${upgrade.rebate}\n`;
        totalProjectCost += upgrade.cost;
        totalRebateAmount += upgrade.rebate;
      });
      
      if (selectedRebates.includes('comboBonus')) {
        selectedUpgrades += `• Combo Bonus - Additional $100 rebate\n`;
        totalRebateAmount += 100;
      }
      
      const applicationText = `RDN IRRIGATION & SOIL IMPROVEMENTS REBATE APPLICATION
Generated: ${formattedDate}

APPLICANT INFORMATION:
Full Name: ${formData.fullName}
Email: ${formData.email}
Primary Phone: ${formData.phoneMain}
Alternate Phone: ${formData.phoneAlt}

Property Address: ${formData.propertyAddress}
City: ${formData.city}
Postal Code: ${formData.postalCode}
Mailing Address: ${formData.mailingAddress}

PROPERTY DETAILS:
Total Irrigated Area: ${formData.irrigatedArea} square feet
Irrigation Season: ${formData.irrigationMonths} months per year
Current Water Usage: ${Math.round(waterBaseline.dailyUsage)} gallons/day average
Estimated Outdoor Water Use: ${Math.round(waterBaseline.outdoorPortion * 100)}%

SELECTED UPGRADES:
${selectedUpgrades}

PROJECT DESCRIPTIONS:
${formData.irrigationDescription ? 'Irrigation Improvements: ' + formData.irrigationDescription + '\n\n' : ''}${formData.soilDescription ? 'Soil Improvements: ' + formData.soilDescription + '\n\n' : ''}${formData.applicationArea ? 'Soil Application Area: ' + formData.applicationArea + ' square feet\n' : ''}${formData.dripArea ? 'Drip Conversion Area: ' + formData.dripArea + ' square feet\n' : ''}

FINANCIAL SUMMARY:
Total Project Cost: $${totalProjectCost}
Total Rebate Amount: $${totalRebateAmount}
Net Project Cost: $${totalProjectCost - totalRebateAmount}

PROJECTED BENEFITS:
Annual Water Savings: ${Math.round(roiResults.totalWaterSavings).toLocaleString()} gallons
Annual Cost Savings: $${Math.round(roiResults.totalCostSavings)}
Payback Period: ${roiResults.paybackYears < 20 ? roiResults.paybackYears.toFixed(1) + ' years' : '20+ years'}
5-Year ROI: ${Math.round(roiResults.roiPercentage)}%

ENVIRONMENTAL IMPACT (10-Year):
Water Conservation: ${Math.round(roiResults.environmentalImpact.lifetimeWaterSavings).toLocaleString()} gallons
CO₂ Reduction: ${roiResults.environmentalImpact.co2Savings * 10} lbs
Total Cost Savings: $${Math.round(roiResults.environmentalImpact.lifetimeCostSavings).toLocaleString()}

Declaration: I certify that the information provided is accurate and complete. I understand that:
• All work must be completed by December 15, 2025
• Receipts and photos are required for rebate processing  
• Professional installation may be required for some upgrades
• Pre-approval is recommended for projects over $500

Applicant Signature: _________________________ Date: _____________

Print Name: ${formData.fullName}`;
      
      document.getElementById('applicationPreview').textContent = applicationText;
      
      // Generate checklist
      generateChecklist();
      
      // Setup PDF download
      setupPDFDownload(applicationText);
    }
    
    function generateChecklist() {
      const checklist = document.getElementById('submissionChecklist');
      
      let checklistItems = [
        'Review and print this completed application form',
        'Obtain quotes from qualified contractors (IIABC recommended)',
        'Take "before" photos of areas to be upgraded',
        'Submit application for pre-approval (recommended for projects >$500)',
        'Complete all work by December 15, 2025',
        'Take "after" photos showing completed installations',
        'Collect all receipts and invoices',
        'Submit rebate claim with photos and receipts within 30 days of completion',
        'Allow 6-8 weeks for rebate processing'
      ];
      
      if (selectedRebates.includes('soilImprovements')) {
        checklistItems.splice(3, 0, 'Ensure soil amendments meet RDN quality standards');
      }
      
      if (selectedRebates.some(r => ['smartController', 'dripConversion'].includes(r))) {
        checklistItems.splice(2, 0, 'Consider professional installation for complex irrigation upgrades');
      }
      
      checklist.innerHTML = checklistItems.map(item => 
        `<div class="checklist-item">${item}</div>`
      ).join('');
    }
    
    function setupPDFDownload(applicationText) {
      document.getElementById('downloadApplication').addEventListener('click', function() {
        if (typeof window.jsPDF === 'undefined') {
          alert('PDF generation is not available. Please copy the application text manually.');
          return;
        }
        
        const { jsPDF } = window.jsPDF;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(16);
        doc.setFont(undefined, 'bold');
        doc.text('RDN Water Conservation ROI Analysis & Application', 20, 20);
        
        // Add generation date
        doc.setFontSize(10);
        doc.setFont(undefined, 'normal');
        doc.text(`Generated: ${new Date().toLocaleDateString()}`, 20, 30);
        
        // ROI Summary Box
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('ROI ANALYSIS SUMMARY', 20, 45);
        
        doc.setFont(undefined, 'normal');
        doc.setFontSize(10);
        const summaryY = 55;
        doc.text(`Annual Water Savings: ${Math.round(roiResults.totalWaterSavings).toLocaleString()} gallons`, 20, summaryY);
        doc.text(`Annual Cost Savings: $${Math.round(roiResults.totalCostSavings)}`, 20, summaryY + 8);
        doc.text(`Total Investment: $${roiResults.totalCost}`, 20, summaryY + 16);
        doc.text(`Total Rebates: $${roiResults.totalRebates}`, 20, summaryY + 24);
        doc.text(`Net Cost: $${roiResults.netCost}`, 20, summaryY + 32);
        doc.text(`Payback Period: ${roiResults.paybackYears < 20 ? roiResults.paybackYears.toFixed(1) + ' years' : '20+ years'}`, 20, summaryY + 40);
        doc.text(`5-Year ROI: ${Math.round(roiResults.roiPercentage)}%`, 20, summaryY + 48);
        
        // Application details
        doc.setFontSize(12);
        doc.setFont(undefined, 'bold');
        doc.text('APPLICATION DETAILS', 20, summaryY + 65);
        
        doc.setFontSize(9);
        doc.setFont(undefined, 'normal');
        
        // Split text into lines for PDF
        const lines = applicationText.split('\n');
        let y = summaryY + 75;
        
        lines.forEach(line => {
          if (y > 270) { // Page break
            doc.addPage();
            y = 20;
          }
          
          if (line.length > 80) {
            const words = line.split(' ');
            let currentLine = '';
            
            words.forEach(word => {
              if ((currentLine + ' ' + word).length > 80) {
                doc.text(currentLine, 20, y);
                y += 6;
                currentLine = word;
              } else {
                currentLine += (currentLine ? ' ' : '') + word;
              }
            });
            
            if (currentLine) {
              doc.text(currentLine, 20, y);
              y += 6;
            }
          } else {
            doc.text(line, 20, y);
            y += line.trim() === '' ? 3 : 6;
          }
        });
        
        // Save the PDF
        const filename = `RDN_Water_Conservation_ROI_Analysis_${formData.fullName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
        doc.save(filename);
      });
    }
    
    // Initialize page
    document.addEventListener('DOMContentLoaded', function() {
      // Set default values
      document.getElementById('irrigationMonths').value = '6';
      document.getElementById('city').value = 'Nanaimo';
      
      // Update usage analysis when irrigated area changes
      document.getElementById('irrigatedArea').addEventListener('input', updateUsageAnalysis);
      document.getElementById('irrigationMonths').addEventListener('input', updateUsageAnalysis);
    });
  </script>
</body>
</html>