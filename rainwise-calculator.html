<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RDN Rebate Application Helper - RainWise Calculator | AI Forester</title>
  <meta name="description" content="Prepare your RDN Irrigation & Soil Improvements rebate application with our step-by-step calculator. Get up to $875 in rebates for water-saving upgrades.">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Arial', sans-serif;
      line-height: 1.6;
      color: #333;
      background-color: #f0f5f3;
    }
    
    .container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background: linear-gradient(135deg, #2c5530 0%, #3a7f42 100%);
      color: white;
      padding: 60px 20px;
      text-align: center;
      margin-bottom: 40px;
      border-radius: 0 0 20px 20px;
    }
    
    h1 {
      font-size: 2.5em;
      margin-bottom: 10px;
      font-weight: 700;
    }
    
    .subtitle {
      font-size: 1.2em;
      opacity: 0.95;
      margin-bottom: 20px;
    }
    
    .badges {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    .badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.9em;
    }
    
    /* RDN Form Helper Section */
    .form-helper {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      border-left: 5px solid #e74c3c;
    }
    
    .form-helper h2 {
      color: #2c5530;
      margin-bottom: 20px;
      text-align: center;
      font-size: 1.8em;
    }
    
    .helper-intro {
      background: #fff3cd;
      border: 1px solid #ffeaa7;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 25px;
    }
    
    .helper-intro h3 {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .helper-intro p {
      color: #856404;
      margin-bottom: 10px;
    }
    
    .rebate-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin: 25px 0;
    }
    
    .rebate-option {
      background: rgba(255,255,255,0.9);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid #e0e0e0;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    
    .rebate-option:hover, .rebate-option.selected {
      border-color: #3a7f42;
      background: #f9fdfb;
    }
    
    .rebate-amount {
      font-size: 1.5em;
      font-weight: bold;
      color: #e74c3c;
      display: block;
      margin-bottom: 8px;
    }
    
    .rebate-title {
      font-weight: 600;
      color: #2c5530;
      margin-bottom: 8px;
    }
    
    .rebate-description {
      font-size: 0.9em;
      color: #666;
    }
    
    .calculator-wrapper {
      background: white;
      border-radius: 15px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      padding: 40px;
      margin-bottom: 40px;
    }
    
    .progress-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 40px;
      position: relative;
    }
    
    .progress-bar::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background: #e0e0e0;
      z-index: 0;
    }
    
    .progress-step {
      position: relative;
      z-index: 1;
      text-align: center;
      flex: 1;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e0e0e0;
      margin: 0 auto 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      color: white;
      transition: all 0.3s ease;
    }
    
    .progress-step.active .step-circle,
    .progress-step.completed .step-circle {
      background: #3a7f42;
    }
    
    .step-label {
      font-size: 0.85em;
      color: #666;
    }
    
    .form-section {
      display: none;
      animation: fadeIn 0.3s ease-in;
    }
    
    .form-section.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .form-group {
      margin-bottom: 25px;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2c5530;
    }
    
    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="tel"],
    select,
    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }
    
    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: #3a7f42;
    }
    
    textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .help-text {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }
    
    .checkbox-group {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .checkbox-item {
      display: flex;
      align-items: start;
      padding: 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
    }
    
    .checkbox-item:hover {
      border-color: #3a7f42;
      background: #f9fdfb;
    }
    
    .checkbox-item input[type="checkbox"] {
      margin-right: 12px;
      margin-top: 3px;
      cursor: pointer;
    }
    
    .checkbox-content {
      flex: 1;
    }
    
    .checkbox-title {
      font-weight: 600;
      margin-bottom: 5px;
    }
    
    .checkbox-description {
      font-size: 0.9em;
      color: #666;
    }
    
    .rebate-amount-inline {
      color: #e74c3c;
      font-weight: bold;
    }
    
    .upgrade-details {
      display: none;
      margin-top: 20px;
      padding: 20px;
      background: #f9fdfb;
      border-radius: 8px;
      border: 1px solid #e0f0e5;
    }
    
    .soil-calculator {
      background: #f0f8ff;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
      border: 1px solid #b3d9ff;
    }
    
    .soil-calculator h4 {
      color: #1e5ba8;
      margin-bottom: 15px;
    }
    
    .soil-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .soil-result {
      background: white;
      padding: 15px;
      border-radius: 8px;
      text-align: center;
    }
    
    .soil-amount {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c5530;
    }
    
    .navigation-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
      gap: 20px;
    }
    
    .btn {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      text-decoration: none;
      display: inline-block;
      text-align: center;
    }
    
    .btn-primary {
      background: #3a7f42;
      color: white;
    }
    
    .btn-primary:hover {
      background: #2c5530;
      transform: translateY(-1px);
    }
    
    .btn-secondary {
      background: #e0e0e0;
      color: #333;
    }
    
    .btn-secondary:hover {
      background: #d0d0d0;
    }
    
    .btn-success {
      background: #4CAF50;
      color: white;
    }
    
    .btn-success:hover {
      background: #45a049;
    }
    
    .results-section {
      display: none;
      margin-top: 40px;
    }
    
    .results-section.active {
      display: block;
    }
    
    .application-preview {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 3px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
      border: 2px solid #3a7f42;
    }
    
    .application-preview h3 {
      color: #2c5530;
      margin-bottom: 20px;
      text-align: center;
    }
    
    .form-preview {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 0.9em;
      white-space: pre-line;
      margin-bottom: 20px;
    }
    
    .checklist {
      background: #fff3cd;
      padding: 20px;
      border-radius: 8px;
      border: 1px solid #ffeaa7;
      margin-bottom: 20px;
    }
    
    .checklist h4 {
      color: #856404;
      margin-bottom: 15px;
    }
    
    .checklist-item {
      display: flex;
      align-items: start;
      margin: 10px 0;
      color: #856404;
    }
    
    .checklist-item::before {
      content: "‚òê ";
      margin-right: 8px;
      font-weight: bold;
    }
    
    .cta-section {
      background: linear-gradient(135deg, #3a7f42 0%, #2c5530 100%);
      color: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
      margin-top: 40px;
    }
    
    .cta-buttons {
      display: flex;
      gap: 20px;
      justify-content: center;
      margin-top: 20px;
      flex-wrap: wrap;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 10px;
      }
      
      .calculator-wrapper {
        padding: 20px;
      }
      
      h1 {
        font-size: 2em;
      }
      
      .badges {
        flex-direction: column;
        align-items: center;
      }
      
      .navigation-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
      
      .rebate-options {
        grid-template-columns: 1fr;
      }
    }
  </style>
  
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>RDN Rebate Application Helper</h1>
      <p class="subtitle">Prepare Your Irrigation & Soil Improvements Application</p>
      <div class="badges">
        <span class="badge">üí∞ Up to $875 in Rebates</span>
        <span class="badge">üìã Form Pre-filled</span>
        <span class="badge">‚úÖ Requirements Checked</span>
        <span class="badge">üìÑ Ready to Submit</span>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Form Helper Introduction -->
    <div class="form-helper">
      <h2>üéØ Get Your RDN Rebate Application Ready</h2>
      <div class="helper-intro">
        <h3>What This Tool Does</h3>
        <p>‚úÖ Walks you through the 2025 RDN Irrigation & Soil Improvements rebate options</p>
        <p>‚úÖ Calculates soil amendment quantities using RDN's official tables</p>
        <p>‚úÖ Pre-fills your application form with all the details</p>
        <p>‚úÖ Generates a checklist of required photos and documentation</p>
        <p>‚úÖ Provides contractor requirements and next steps</p>
      </div>
      
      <div class="rebate-options">
        <div class="rebate-option">
          <span class="rebate-amount">Up to $875</span>
          <div class="rebate-title">Total Available Rebates</div>
          <div class="rebate-description">Combine multiple upgrades for maximum savings</div>
        </div>
        <div class="rebate-option">
          <span class="rebate-amount">90 Days</span>
          <div class="rebate-title">Pre-approval Period</div>
          <div class="rebate-description">Time to complete your approved upgrades</div>
        </div>
        <div class="rebate-option">
          <span class="rebate-amount">Dec 15, 2025</span>
          <div class="rebate-title">Program Deadline</div>
          <div class="rebate-description">All work must be completed by this date</div>
        </div>
      </div>
    </div>

    <div class="calculator-wrapper" id="calculatorSection">
      <!-- Progress Bar -->
      <div class="progress-bar">
        <div class="progress-step active" id="step1">
          <div class="step-circle">1</div>
          <div class="step-label">Property Info</div>
        </div>
        <div class="progress-step" id="step2">
          <div class="step-circle">2</div>
          <div class="step-label">Select Rebates</div>
        </div>
        <div class="progress-step" id="step3">
          <div class="step-circle">3</div>
          <div class="step-label">Project Details</div>
        </div>
        <div class="progress-step" id="step4">
          <div class="step-circle">4</div>
          <div class="step-label">Application Ready</div>
        </div>
      </div>

      <!-- Step 1: Property Owner Information -->
      <div class="form-section active" id="section1">
        <h2>Property Owner Information</h2>
        <p class="help-text">This information will be used to pre-fill your RDN application form.</p>
        
        <div class="form-group">
          <label for="fullName">Full Name (Property Owner)</label>
          <input type="text" id="fullName" placeholder="John Smith">
        </div>
        
        <div class="form-group">
          <label for="phoneMain">Phone Number (Main)</label>
          <input type="tel" id="phoneMain" placeholder="250-555-0123">
        </div>
        
        <div class="form-group">
          <label for="phoneAlt">Phone Number (Alternate)</label>
          <input type="tel" id="phoneAlt" placeholder="250-555-0456">
        </div>
        
        <div class="form-group">
          <label for="email">Email Address</label>
          <input type="email" id="email" placeholder="john.smith@email.com">
        </div>
        
        <div class="form-group">
          <label for="propertyAddress">RDN Property Address</label>
          <input type="text" id="propertyAddress" placeholder="123 Main Street">
        </div>
        
        <div class="form-group">
          <label for="city">City/Town</label>
          <input type="text" id="city" placeholder="Nanaimo">
        </div>
        
        <div class="form-group">
          <label for="postalCode">Postal Code</label>
          <input type="text" id="postalCode" placeholder="V9S 1A1" maxlength="7">
        </div>
        
        <div class="form-group">
          <label for="mailingAddress">Mailing Address (if different)</label>
          <input type="text" id="mailingAddress" placeholder="Leave blank if same as property address">
        </div>
        
        <div class="navigation-buttons">
          <div></div>
          <button class="btn btn-primary" onclick="nextStep(1)">Next: Select Rebates ‚Üí</button>
        </div>
      </div>

      <!-- Step 2: Rebate Selection -->
      <div class="form-section" id="section2">
        <h2>Select Your Rebate Options</h2>
        <p class="help-text">Choose the upgrades you want to apply for. You can combine multiple options.</p>
        
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="rainSensor" name="rebates" value="rainSensor" onchange="toggleUpgradeDetails('rainSensor')">
            <div class="checkbox-content">
              <div class="checkbox-title">Rain Sensor <span class="rebate-amount-inline">($75 rebate)</span></div>
              <div class="checkbox-description">Automatically shuts off irrigation when it's raining</div>
            </div>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" id="smartController" name="rebates" value="smartController" onchange="toggleUpgradeDetails('smartController')">
            <div class="checkbox-content">
              <div class="checkbox-title">Smart Controller <span class="rebate-amount-inline">($100 rebate)</span></div>
              <div class="checkbox-description">Weather-based irrigation control system</div>
            </div>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" id="dripConversion" name="rebates" value="dripConversion" onchange="toggleUpgradeDetails('dripConversion')">
            <div class="checkbox-content">
              <div class="checkbox-title">Drip Irrigation Conversion <span class="rebate-amount-inline">($400 rebate)</span></div>
              <div class="checkbox-description">Convert conventional sprinklers to drip irrigation</div>
            </div>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" id="mpRotators" name="rebates" value="mpRotators" onchange="toggleUpgradeDetails('mpRotators')">
            <div class="checkbox-content">
              <div class="checkbox-title">MP Rotator Nozzles <span class="rebate-amount-inline">($100 rebate)</span></div>
              <div class="checkbox-description">High-efficiency matched precipitation rotator nozzles</div>
            </div>
          </div>
          
          <div class="checkbox-item">
            <input type="checkbox" id="soilImprovements" name="rebates" value="soilImprovements" onchange="toggleUpgradeDetails('soilImprovements')">
            <div class="checkbox-content">
              <div class="checkbox-title">Soil Improvements <span class="rebate-amount-inline">(50% of costs, max $100)</span></div>
              <div class="checkbox-description">Quality topsoil, compost, or organic mulch</div>
            </div>
          </div>
          
          <div class="checkbox-item" style="background: #e8f5ea; border-color: #4CAF50;">
            <input type="checkbox" id="comboBonus" name="rebates" value="comboBonus" disabled>
            <div class="checkbox-content">
              <div class="checkbox-title">üéâ Combo Bonus <span class="rebate-amount-inline">(+$100)</span></div>
              <div class="checkbox-description">Automatically applied when you do both irrigation upgrades AND soil improvements</div>
            </div>
          </div>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn btn-secondary" onclick="previousStep(2)">‚Üê Back</button>
          <button class="btn btn-primary" onclick="nextStep(2)">Next: Project Details ‚Üí</button>
        </div>
      </div>

      <!-- Step 3: Project Details -->
      <div class="form-section" id="section3">
        <h2>Project Details</h2>
        
        <!-- Irrigation Upgrade Details -->
        <div class="upgrade-details" id="irrigationDetails" style="display: none;">
          <h3>üöø Irrigation System Upgrades</h3>
          <div class="form-group">
            <label for="irrigationDescription">Description of irrigation upgrade(s)</label>
            <textarea id="irrigationDescription" placeholder="Describe what you plan to upgrade (e.g., 'Install smart controller to replace existing timer controller for 6-zone system in front and back yard')"></textarea>
            <p class="help-text"><strong>Important:</strong> Must be completed by an IIABC certified professional</p>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="irrigationPhotos">
              I will submit photos of my irrigation system showing current deficiencies
            </label>
            <p class="help-text">Photos are required with your application</p>
          </div>
        </div>
        
        <!-- Soil Improvements Details -->
        <div class="upgrade-details" id="soilDetails" style="display: none;">
          <h3>üå± Soil Improvements</h3>
          <div class="form-group">
            <label for="soilDescription">Description of soil improvement(s)</label>
            <textarea id="soilDescription" placeholder="Describe your soil improvement plans (e.g., 'Add 2 inches of quality compost to 500 sq ft of garden beds to improve soil health and water retention')"></textarea>
            <p class="help-text">Can be completed by homeowner or IIABC certified professional</p>
          </div>
          
          <div class="form-group">
            <label for="applicationArea">Application Area (sq ft)</label>
            <input type="number" id="applicationArea" placeholder="500" min="0" onchange="calculateSoilAmounts()">
            <p class="help-text">Size of garden or lawn area to be improved</p>
          </div>
          
          <div class="form-group">
            <label for="applicationDepth">Application Type</label>
            <select id="applicationDepth" onchange="calculateSoilAmounts()">
              <option value="">Select application type</option>
              <option value="garden">Garden Beds (2 inch depth)</option>
              <option value="lawn">Lawn Topdressing (1/4 inch depth)</option>
            </select>
          </div>
          
          <div class="soil-calculator" id="soilCalculator" style="display: none;">
            <h4>üìä Required Soil Amendment (Based on RDN Table)</h4>
            <div class="soil-grid">
              <div class="soil-result">
                <div class="soil-amount" id="bagsNeeded">0 bags</div>
                <div>28-Litre Bags</div>
              </div>
              <div class="soil-result">
                <div class="soil-amount" id="cubicYards">0 cubic yards</div>
                <div>Bulk Quantity</div>
              </div>
              <div class="soil-result">
                <div class="soil-amount" id="estimatedCost">$0 - $0</div>
                <div>Estimated Cost</div>
              </div>
            </div>
          </div>
          
          <div class="form-group">
            <label>
              <input type="checkbox" id="soilPhotos">
              I will submit photos of garden/lawn area requiring soil improvements
            </label>
            <p class="help-text">Photos are required with your application</p>
          </div>
        </div>
        
        <div class="navigation-buttons">
          <button class="btn btn-secondary" onclick="previousStep(3)">‚Üê Back</button>
          <button class="btn btn-success" onclick="generateApplication()">Generate Application ‚Üí</button>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <div class="application-preview">
        <h3>üìã Your Pre-filled RDN Application</h3>
        <div class="form-preview" id="applicationPreview"></div>
        
        <div class="checklist">
          <h4>üìã Submission Checklist</h4>
          <div id="submissionChecklist"></div>
        </div>
      </div>
      
      <div class="cta-section">
        <h2>Ready to Apply for Your Rebates!</h2>
        <p>Your application is pre-filled and ready to submit to RDN.</p>
        <div class="cta-buttons">
          <button class="btn btn-primary" id="downloadApplication">üìÑ Download Application (PDF)</button>
          <a href="https://www.rdn.bc.ca/sites/default/files/inline-files/2025%20I%26S%20Pre-approval%20Application%20Form.pdf" target="_blank" class="btn btn-secondary">üìã Download Official Form</a>
          <a href="https://www.irrigationbc.com" target="_blank" class="btn btn-secondary">üîç Find IIABC Professionals</a>
          <button class="btn btn-secondary" onclick="location.reload()">üîÑ Start New Application</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let currentStep = 1;
    let formData = {};
    let selectedRebates = [];
    
    // Navigation functions
    function nextStep(step) {
      if (!validateStep(step)) return;
      
      // Update progress bar
      document.getElementById(`step${step}`).classList.add('completed');
      document.getElementById(`step${step + 1}`).classList.add('active');
      
      // Hide current section, show next
      document.getElementById(`section${step}`).classList.remove('active');
      document.getElementById(`section${step + 1}`).classList.add('active');
      
      currentStep = step + 1;
      
      // Show relevant upgrade details on step 3
      if (currentStep === 3) {
        showSelectedUpgradeDetails();
      }
    }
    
    function previousStep(step) {
      // Update progress bar
      document.getElementById(`step${step}`).classList.remove('active');
      document.getElementById(`step${step - 1}`).classList.remove('completed');
      
      // Hide current section, show previous
      document.getElementById(`section${step}`).classList.remove('active');
      document.getElementById(`section${step - 1}`).classList.add('active');
      
      currentStep = step - 1;
    }
    
    function validateStep(step) {
      if (step === 1) {
        const required = ['fullName', 'phoneMain', 'email', 'propertyAddress', 'city', 'postalCode'];
        for (let field of required) {
          if (!document.getElementById(field).value.trim()) {
            alert(`Please fill in the ${field.replace(/([A-Z])/g, ' $1').toLowerCase()} field`);
            return false;
          }
        }
      }
      
      if (step === 2) {
        const checkedRebates = document.querySelectorAll('input[name="rebates"]:checked:not([disabled])');
        if (checkedRebates.length === 0) {
          alert('Please select at least one rebate option');
          return false;
        }
      }
      
      return true;
    }
    
    function toggleUpgradeDetails(upgrade) {
      updateSelectedRebates();
      updateComboBonus();
    }
    
    function updateSelectedRebates() {
      selectedRebates = Array.from(document.querySelectorAll('input[name="rebates"]:checked:not([disabled])'))
                           .map(cb => cb.value);
    }
    
    function updateComboBonus() {
      const hasIrrigation = selectedRebates.some(r => ['rainSensor', 'smartController', 'dripConversion', 'mpRotators'].includes(r));
      const hasSoil = selectedRebates.includes('soilImprovements');
      
      const comboCheckbox = document.getElementById('comboBonus');
      if (hasIrrigation && hasSoil) {
        comboCheckbox.checked = true;
        comboCheckbox.parentElement.style.display = 'flex';
      } else {
        comboCheckbox.checked = false;
        comboCheckbox.parentElement.style.display = 'flex';
      }
    }
    
    function showSelectedUpgradeDetails() {
      // Hide all upgrade details first
      document.querySelectorAll('.upgrade-details').forEach(detail => {
        detail.style.display = 'none';
      });
      
      // Show irrigation details if any irrigation upgrade is selected
      const hasIrrigation = selectedRebates.some(r => ['rainSensor', 'smartController', 'dripConversion', 'mpRotators'].includes(r));
      if (hasIrrigation) {
        document.getElementById('irrigationDetails').style.display = 'block';
      }
      
      // Show soil details if soil improvements is selected
      if (selectedRebates.includes('soilImprovements')) {
        document.getElementById('soilDetails').style.display = 'block';
      }
    }
    
    function calculateSoilAmounts() {
      const area = parseFloat(document.getElementById('applicationArea').value) || 0;
      const depthType = document.getElementById('applicationDepth').value;
      
      if (area === 0 || !depthType) {
        document.getElementById('soilCalculator').style.display = 'none';
        return;
      }
      
      let bags, cubicYards, minCost, maxCost;
      
      // RDN table calculations based on sq ft
      if (depthType === 'garden') { // 2 inch depth
        bags = Math.ceil((area / 400) * 67); // 67 bags per 400 sq ft
        cubicYards = (area / 400) * 2.4; // 2.4 cubic yards per 400 sq ft
        minCost = bags * 8; // ~$8-12 per bag
        maxCost = bags * 12;
      } else { // lawn topdressing - 1/4 inch depth
        bags = Math.ceil((area / 400) * 10); // 10 bags per 400 sq ft
        cubicYards = (area / 400) * 0.32; // 0.32 cubic yards per 400 sq ft
        minCost = bags * 8;
        maxCost = bags * 12;
      }
      
      document.getElementById('bagsNeeded').textContent = `${bags} bags`;
      document.getElementById('cubicYards').textContent = `${cubicYards.toFixed(1)} cubic yards`;
      document.getElementById('estimatedCost').textContent = `$${minCost} - $${maxCost}`;
      document.getElementById('soilCalculator').style.display = 'block';
    }
    
    function generateApplication() {
      collectFormData();
      
      let applicationText = "RDN IRRIGATION UPGRADES & SOIL IMPROVEMENTS\nPRE-APPROVAL APPLICATION\n\n";
      applicationText += "1. PROPERTY OWNER(S):\n";
      applicationText += `Full Name: ${formData.fullName}\n`;
      applicationText += `Phone Number (main): ${formData.phoneMain}\n`;
      applicationText += `Phone Number (alternate): ${formData.phoneAlt || 'N/A'}\n`;
      applicationText += `E-mail Address: ${formData.email}\n`;
      applicationText += `RDN Property Address: ${formData.propertyAddress}\n`;
      applicationText += `City/Town: ${formData.city}\n`;
      applicationText += `Postal Code: ${formData.postalCode}\n`;
      
      if (formData.mailingAddress) {
        applicationText += `Mailing Address: ${formData.mailingAddress}\n`;
      }
      
      applicationText += "\n2. REBATE REQUEST:\n";
      applicationText += "I am applying for pre-approval for the following eligible upgrade(s):\n\n";
      
      let totalRebate = 0;
      
      if (selectedRebates.includes('rainSensor')) {
        applicationText += "‚òë Rain Sensor ‚Äì maximum rebate $75\n";
        totalRebate += 75;
      }
      
      if (selectedRebates.includes('smartController')) {
        applicationText += "‚òë Addition of Smart Controller ‚Äì maximum rebate $100\n";
        totalRebate += 100;
      }
      
      if (selectedRebates.includes('dripConversion')) {
        applicationText += "‚òë Conversion of conventional sprinklers to Drip Irrigation ‚Äì maximum rebate $400\n";
        totalRebate += 400;
      }
      
      if (selectedRebates.includes('mpRotators')) {
        applicationText += "‚òë Conversion of conventional sprinklers to Matched Precipitation (MP) Rotators ‚Äì maximum rebate $100\n";
        totalRebate += 100;
      }
      
      if (selectedRebates.includes('soilImprovements')) {
        applicationText += "‚òë Addition of quality top soil, compost, organic mulch ‚Äì 50% of costs, maximum rebate $100\n";
        totalRebate += 100;
      }
      
      if (selectedRebates.includes('soilImprovements') && selectedRebates.some(r => ['rainSensor', 'smartController', 'dripConversion', 'mpRotators'].includes(r))) {
        applicationText += "‚òë I am completing both Irrigation Upgrades & Soil Improvements ‚Äì BONUS $100\n";
        totalRebate += 100;
      }
      
      applicationText += `\nTOTAL REBATE AMOUNT: $${totalRebate}\n`;
      
      applicationText += "\n3. UPGRADE DETAILS:\n";
      
      if (formData.irrigationDescription) {
        applicationText += "IRRIGATION UPGRADES REBATE:\n";
        applicationText += `${formData.irrigationDescription}\n\n`;
        if (formData.irrigationPhotos) {
          applicationText += "‚òë I have submitted with my application, photo(s) of the irrigation system\n\n";
        }
      }
      
      if (formData.soilDescription) {
        applicationText += "SOIL IMPROVEMENTS REBATE:\n";
        applicationText += `${formData.soilDescription}\n`;
        
        if (formData.applicationArea && formData.applicationDepth) {
          applicationText += `Area: ${formData.applicationArea} sq ft\n`;
          applicationText += `Type: ${formData.applicationDepth === 'garden' ? 'Garden Beds (2 inch depth)' : 'Lawn Topdressing (1/4 inch depth)'}\n`;
          
          // Add soil calculation results
          const bags = document.getElementById('bagsNeeded').textContent;
          const cubicYards = document.getElementById('cubicYards').textContent;
          applicationText += `Required: ${bags} (28-litre) or ${cubicYards} bulk\n`;
        }
        
        if (formData.soilPhotos) {
          applicationText += "‚òë I have submitted with my application, photo(s) of the garden/lawn area\n";
        }
      }
      
      applicationText += "\n‚òë Acknowledgement: I understand that I am not pre-approved until I receive my confirmation letter.\n";
      applicationText += "Pre-approval expires 90 days after the confirmation letter is issued.\n";
      
      // Generate checklist
      let checklist = "";
      
      checklist += '<div class="checklist-item">Print and sign the completed application form</div>';
      
      if (formData.irrigationDescription) {
        checklist += '<div class="checklist-item">Take photos of current irrigation system showing deficiencies</div>';
        checklist += '<div class="checklist-item">Contact IIABC certified professional for irrigation work</div>';
      }
      
      if (formData.soilDescription) {
        checklist += '<div class="checklist-item">Take photos of garden/lawn area requiring soil improvements</div>';
        if (formData.applicationArea) {
          const bags = document.getElementById('bagsNeeded').textContent;
          checklist += `<div class="checklist-item">Purchase ${bags} of quality compost/topsoil OR equivalent bulk quantity</div>`;
        }
      }
      
      checklist += '<div class="checklist-item">Submit application by mail, fax, or email to RDN</div>';
      checklist += '<div class="checklist-item">Wait for pre-approval confirmation letter</div>';
      checklist += '<div class="checklist-item">Complete all work within 90 days of approval</div>';
      checklist += '<div class="checklist-item">Submit claim form with receipts and photos after completion</div>';
      
      // Display results
      document.getElementById('applicationPreview').textContent = applicationText;
      document.getElementById('submissionChecklist').innerHTML = checklist;
      
      // Show results section
      document.getElementById('calculatorSection').style.display = 'none';
      document.getElementById('resultsSection').classList.add('active');
      
      document.getElementById('resultsSection').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'start' 
      });
      
      // Store for PDF generation
      window.applicationData = {
        text: applicationText,
        rebateAmount: totalRebate,
        checklist: checklist
      };
    }
    
    function collectFormData() {
      // Property owner info
      formData.fullName = document.getElementById('fullName').value;
      formData.phoneMain = document.getElementById('phoneMain').value;
      formData.phoneAlt = document.getElementById('phoneAlt').value;
      formData.email = document.getElementById('email').value;
      formData.propertyAddress = document.getElementById('propertyAddress').value;
      formData.city = document.getElementById('city').value;
      formData.postalCode = document.getElementById('postalCode').value;
      formData.mailingAddress = document.getElementById('mailingAddress').value;
      
      // Project details
      formData.irrigationDescription = document.getElementById('irrigationDescription').value;
      formData.irrigationPhotos = document.getElementById('irrigationPhotos').checked;
      formData.soilDescription = document.getElementById('soilDescription').value;
      formData.applicationArea = document.getElementById('applicationArea').value;
      formData.applicationDepth = document.getElementById('applicationDepth').value;
      formData.soilPhotos = document.getElementById('soilPhotos').checked;
      
      updateSelectedRebates();
    }
    
    // PDF Generation
    document.addEventListener('DOMContentLoaded', function() {
      const downloadBtn = document.getElementById('downloadApplication');
      if (downloadBtn) {
        downloadBtn.addEventListener('click', function() {
          generatePDF();
        });
      }
    });
    
    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      // Title
      doc.setFontSize(16);
      doc.text('RDN Irrigation & Soil Improvements', 20, 20);
      doc.text('Pre-approval Application', 20, 30);
      
      // Add application text
      const lines = window.applicationData.text.split('\n');
      let yPos = 50;
      
      doc.setFontSize(10);
      lines.forEach(line => {
        if (yPos > 270) {
          doc.addPage();
          yPos = 20;
        }
        
        if (line.includes(':') && !line.includes('‚òë')) {
          doc.setFont(undefined, 'bold');
        } else {
          doc.setFont(undefined, 'normal');
        }
        
        const splitLine = doc.splitTextToSize(line, 170);
        doc.text(splitLine, 20, yPos);
        yPos += splitLine.length * 5;
      });
      
      // Add submission info
      doc.addPage();
      doc.setFontSize(14);
      doc.text('Submission Information', 20, 20);
      
      doc.setFontSize(10);
      doc.setFont(undefined, 'normal');
      doc.text('Submit completed application to:', 20, 35);
      doc.text('Drinking Water & Watershed Protection', 20, 45);
      doc.text('Regional District of Nanaimo', 20, 55);
      doc.text('6300 Hammond Bay Road, Nanaimo, BC, V9T 6N2', 20, 65);
      doc.text('Fax: 250-390-1542', 20, 75);
      doc.text('Email: watersmart@rdn.bc.ca', 20, 85);
      
      doc.text('Important Notes:', 20, 100);
      doc.text('‚Ä¢ Work must be completed between January 1 - December 15, 2025', 20, 110);
      doc.text('‚Ä¢ Pre-approval expires 90 days after confirmation letter', 20, 120);
      doc.text('‚Ä¢ Submit claim form with receipts after work completion', 20, 130);
      
      // Save the PDF
      doc.save('RDN-Rebate-Application-' + formData.fullName.replace(/\s+/g, '-') + '.pdf');
    }
  </script>
</body>
</html>