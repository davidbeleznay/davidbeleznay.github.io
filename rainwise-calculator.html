<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RDN Water Savings & Rebate Finder | AI Forester</title>
  <meta name="description" content="Discover your RDN water rebates (up to $1,625 with rainwater harvesting), calculate water savings in cubic meters, and see the true environmental value of water during peak salmon periods.">
  <link rel="stylesheet" href="rainwise-calculator.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <header>
    <div class="container">
      <h1>RDN Water Savings & Rebate Finder</h1>
      <p class="subtitle">Discover how much water and money you can save with RDN rebates â€” and see the true environmental value of water during critical salmon periods.</p>
      <div class="badges">
        <span class="badge">ğŸ’° Up to $1,625 in Rebates</span>
        <span class="badge">ğŸ’§ Save Thousands of mÂ³</span>
        <span class="badge">ğŸŸ Protect Salmon Habitat</span>
        <span class="badge">ğŸ“Š True Water Value Calculator</span>
      </div>
    </div>
  </header>

  <div class="container">
    <div class="rebate-highlight-box">
      <h2>ğŸ’¡ Did you know?</h2>
      <p>You can get <strong>up to $875 in rebates</strong> for irrigation upgrades like smart controllers and drip irrigation. Plus, rainwater harvesting systems qualify for an additional <strong>50% rebate up to $750</strong> â€” that's potentially <strong>$1,625 in total savings</strong>!</p>
      <p class="salmon-highlight">ğŸŸ <strong>Peak Salmon Protection:</strong> During June-September, water's true environmental value is <strong>$1.00/mÂ³ higher</strong> due to critical habitat needs.</p>
      <div class="program-links">
        <a href="https://rdn.bc.ca/irrigation-upgrades-and-soil-improvements" target="_blank" class="program-link">View Irrigation Rebates â†’</a>
        <a href="https://rdn.bc.ca/rainwater-harvesting" target="_blank" class="program-link">View Rainwater Harvesting â†’</a>
      </div>
    </div>

    <div class="calculator-wrapper">
      <div class="progress-bar">
        <div class="progress-step active" id="step1"><div class="step-circle">1</div><div class="step-label">Property Info</div></div>
        <div class="progress-step" id="step2"><div class="step-circle">2</div><div class="step-label">Current Usage</div></div>
        <div class="progress-step" id="step3"><div class="step-circle">3</div><div class="step-label">Select Upgrades</div></div>
        <div class="progress-step" id="step4"><div class="step-circle">4</div><div class="step-label">Your Savings</div></div>
      </div>

      <!-- Step 1: Property Information -->
      <div class="form-section active" id="section1">
        <h2>Let's Start with Your Property</h2>
        <div class="form-row">
          <div class="form-group"><label for="fullName">Your Name</label><input type="text" id="fullName" placeholder="John Smith"></div>
          <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="john@email.com"></div>
        </div>
        <div class="form-row">
          <div class="form-group"><label for="phoneMain">Phone Number</label><input type="tel" id="phoneMain" placeholder="250-555-0123"></div>
          <div class="form-group"><label for="phoneAlt">Alternative Phone</label><input type="tel" id="phoneAlt" placeholder="250-555-0456"></div>
        </div>
        <div class="form-group"><label for="propertyAddress">Property Address</label><input type="text" id="propertyAddress" placeholder="123 Main Street"></div>
        <div class="form-row">
          <div class="form-group">
            <label for="city">City/Area within RDN</label>
            <input type="text" id="city" placeholder="e.g., Nanaimo, Parksville, Qualicum Beach" list="rdnCities">
            <datalist id="rdnCities">
              <option value="Nanaimo">
              <option value="Parksville">
              <option value="Qualicum Beach">
              <option value="Lantzville">
              <option value="Gabriola Island">
              <option value="Cedar">
              <option value="Ladysmith">
              <option value="Coombs">
              <option value="Errington">
              <option value="French Creek">
            </datalist>
          </div>
          <div class="form-group"><label for="postalCode">Postal Code</label><input type="text" id="postalCode" placeholder="V9S 1A1"></div>
        </div>
        <div class="form-group">
          <label for="propertyType">Property Type</label>
          <select id="propertyType" onchange="updatePropertyDefaults()">
            <option value="single">Single Family Home</option>
            <option value="townhouse">Townhouse</option>
            <option value="condo">Condo with Garden</option>
            <option value="large">Large Estate (1+ acre)</option>
          </select>
        </div>
        <button class="btn btn-primary" onclick="nextStep(1)" style="float:right;">Next: Water Usage â†’</button>
      </div>

      <!-- Step 2: Water Usage Baseline - ENHANCED VERSION -->
      <div class="form-section" id="section2">
        <h2>Current Water Usage</h2>
        <div class="form-row">
          <div class="form-group">
            <label for="irrigatedArea">Irrigated Area (sq ft)</label>
            <input type="number" id="irrigatedArea" placeholder="2000" onchange="updateUsageAnalysis()">
            <p class="help-text">Total lawn and garden area that receives irrigation</p>
          </div>
          <div class="form-group">
            <label for="irrigationMonths">Irrigation Months/Year</label>
            <input type="number" id="irrigationMonths" placeholder="6" value="6" onchange="updateUsageAnalysis()">
            <p class="help-text">Typically May-October in the RDN region</p>
          </div>
        </div>
        <div class="form-group">
          <label for="irrigationSystem">Current Irrigation System</label>
          <select id="irrigationSystem" onchange="updateUsageAnalysis()">
            <option value="manual">Manual Watering (hose/sprinkler)</option>
            <option value="timer">Basic Timer System</option>
            <option value="inground">In-ground Sprinklers</option>
            <option value="mixed">Mixed System</option>
          </select>
        </div>
        
        <h3>Recent Water Bills (Enter in Cubic Meters)</h3>
        <p class="help-text">Enter your water consumption from Nanaimo water bills in cubic meters (mÂ³) to calculate true costs including peak salmon protection periods</p>
        
        <div class="water-usage-grid">
          <div>
            <label for="usage1">Winter (mÂ³)</label>
            <input type="number" id="usage1" placeholder="30" step="0.1" onchange="updateUsageAnalysis()">
            <span class="period-label">Dec-Feb</span>
          </div>
          <div>
            <label for="usage2">Spring (mÂ³)</label>
            <input type="number" id="usage2" placeholder="45" step="0.1" onchange="updateUsageAnalysis()">
            <span class="period-label">Mar-May</span>
          </div>
          <div class="peak-period">
            <label for="usage3">Summer (mÂ³) ğŸŸ</label>
            <input type="number" id="usage3" placeholder="75" step="0.1" onchange="updateUsageAnalysis()">
            <span class="period-label peak">Jun-Aug (Peak Salmon)</span>
          </div>
          <div>
            <label for="usage4">Fall (mÂ³)</label>
            <input type="number" id="usage4" placeholder="55" step="0.1" onchange="updateUsageAnalysis()">
            <span class="period-label">Sep-Nov</span>
          </div>
        </div>
        
        <div class="usage-analysis" id="usageAnalysis" style="display:none;">
          <h4>ğŸ’§ Your Water Usage & True Cost Summary</h4>
          <div class="analysis-grid">
            <div class="analysis-metric">
              <div class="metric-value" id="avgDailyUsage">0 L/day</div>
              <div>Daily Usage</div>
            </div>
            <div class="analysis-metric">
              <div class="metric-value" id="annualUsage">0 mÂ³</div>
              <div>Annual Usage</div>
            </div>
            <div class="analysis-metric highlight">
              <div class="metric-value" id="peakUsage">0 mÂ³</div>
              <div>Peak Salmon Period</div>
            </div>
            <div class="analysis-metric">
              <div class="metric-value" id="savingsPotential">0 mÂ³/year</div>
              <div>Savings Potential</div>
            </div>
          </div>
          
          <div class="water-cost-breakdown" id="waterCostBreakdown" style="display:none;">
            <h5>ğŸ’° Your Water Costs (Based on Nanaimo Rates)</h5>
            <div class="cost-table">
              <div class="cost-row">
                <span>City Water Bill (annual):</span>
                <span id="cityBillAmount">$0</span>
              </div>
              <div class="cost-row highlight">
                <span>True Environmental Value:</span>
                <span id="trueValueAmount">$0</span>
              </div>
              <div class="cost-row">
                <span>Hidden Subsidy (ecosystem impact):</span>
                <span id="hiddenSubsidy">$0</span>
              </div>
            </div>
            <div class="peak-warning" style="margin-top:15px;padding:10px;background:#fff3cd;border-left:4px solid #ff9800;">
              <strong>ğŸŸ Peak Salmon Impact:</strong> Every mÂ³ saved during June-September has <strong>10x the environmental benefit</strong> for local salmon populations.
            </div>
          </div>
        </div>
        
        <div style="display:flex;justify-content:space-between;margin-top:30px;">
          <button class="btn btn-secondary" onclick="previousStep(2)">â† Back</button>
          <button class="btn btn-primary" onclick="nextStep(2)">Next: Upgrades â†’</button>
        </div>
      </div>

      <!-- Step 3: Select Upgrades -->
      <div class="form-section" id="section3">
        <h2>Select Your Water-Saving Upgrades</h2>
        <div class="checkbox-group">
          <div class="checkbox-item">
            <input type="checkbox" id="rainSensor" value="rainSensor" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">Rain Sensor <span class="rebate-amount-inline">($75 rebate)</span></div>
              <div class="checkbox-description">Save 10-15% â€¢ Prevents watering in rain â€¢ Quick payback</div>
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="smartController" value="smartController" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">Smart Controller <span class="rebate-amount-inline">($100 rebate)</span></div>
              <div class="checkbox-description">Save 20-40% â€¢ Weather-based scheduling â€¢ Top water saver</div>
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="dripConversion" value="dripConversion" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">Drip Irrigation <span class="rebate-amount-inline">($400 rebate)</span></div>
              <div class="checkbox-description">Save 30-50% â€¢ Targeted root watering â€¢ Highest rebate</div>
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="mpRotators" value="mpRotators" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">MP Rotators <span class="rebate-amount-inline">($100 rebate)</span></div>
              <div class="checkbox-description">Save 20-30% â€¢ Even water distribution â€¢ Less runoff</div>
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="soilImprovements" value="soilImprovements" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">Soil Improvements <span class="rebate-amount-inline">(50% up to $100)</span></div>
              <div class="checkbox-description">Save 25% on watering â€¢ Better water retention â€¢ Often free with rebate</div>
            </div>
          </div>
          <div class="checkbox-item">
            <input type="checkbox" id="rainwaterHarvesting" value="rainwaterHarvesting" onchange="toggleUpgradeDetails(this.value)">
            <div class="checkbox-content">
              <div class="checkbox-title">Rainwater Harvesting <span class="rebate-amount-inline">(50% up to $750)</span></div>
              <div class="checkbox-description">Save 100% on outdoor water â€¢ Drought-proof â€¢ Highest savings</div>
            </div>
          </div>
        </div>
        
        <!-- Upgrade Details sections remain the same... -->
        <div class="upgrade-details" id="rainSensorDetails">
          <h3>Rain Sensor Details</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="rainSensorCost">Installation Cost Estimate ($)</label>
              <input type="number" id="rainSensorCost" value="150">
              <p class="help-text">Includes sensor and professional installation</p>
            </div>
            <div class="form-group">
              <label for="rainSensorSavings">Expected Water Savings (%)</label>
              <input type="number" id="rainSensorSavings" value="15" min="10" max="20">
            </div>
          </div>
        </div>
        
        <div class="upgrade-details" id="smartControllerDetails">
          <h3>Smart Controller Details</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="controllerZones">Number of Zones</label>
              <select id="controllerZones" onchange="updateControllerCost()">
                <option value="4">4 zones</option>
                <option value="8" selected>8 zones</option>
                <option value="12">12 zones</option>
                <option value="16">16 zones</option>
              </select>
            </div>
            <div class="form-group">
              <label for="controllerCost">Installation Cost Estimate ($)</label>
              <input type="number" id="controllerCost" value="450">
            </div>
          </div>
          <div class="form-group">
            <label for="controllerSavings">Expected Water Savings (%)</label>
            <input type="number" id="controllerSavings" value="30" min="20" max="40">
          </div>
        </div>
        
        <div class="upgrade-details" id="dripConversionDetails">
          <h3>Drip Irrigation Conversion</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="dripArea">Area to Convert (sq ft)</label>
              <input type="number" id="dripArea" placeholder="1000" onchange="updateDripCost()">
              <p class="help-text">Garden beds and shrub areas</p>
            </div>
            <div class="form-group">
              <label for="dripCost">Installation Cost Estimate ($)</label>
              <input type="number" id="dripCost" value="1200">
            </div>
          </div>
          <div class="form-group">
            <label for="dripSavings">Expected Water Savings (%)</label>
            <input type="number" id="dripSavings" value="40" min="30" max="50">
          </div>
          <div class="cost-estimate-box">
            <h4>ğŸ’° Cost Estimate: $1.00-1.50 per sq ft</h4>
            <div class="cost-grid">
              <div class="cost-item"><div class="cost-value">$0.40-0.60</div><div class="cost-label">Materials/sq ft</div></div>
              <div class="cost-item"><div class="cost-value">$0.60-0.90</div><div class="cost-label">Labor/sq ft</div></div>
              <div class="cost-item"><div class="cost-value" id="dripTotalEstimate">$1,200</div><div class="cost-label">Your Estimate</div></div>
            </div>
          </div>
          <div class="form-group">
            <label for="irrigationDescription">Project Description</label>
            <textarea id="irrigationDescription" placeholder="Describe conversion plans (e.g., 'Convert 1000 sq ft of garden beds from spray heads to drip irrigation with pressure compensating emitters')"></textarea>
          </div>
        </div>
        
        <div class="upgrade-details" id="mpRotatorsDetails">
          <h3>MP Rotator Nozzles</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="rotatorHeads">Number of Heads</label>
              <input type="number" id="rotatorHeads" value="20" onchange="updateRotatorCost()">
            </div>
            <div class="form-group">
              <label for="rotatorCost">Installation Cost Estimate ($)</label>
              <input type="number" id="rotatorCost" value="400">
            </div>
          </div>
          <div class="form-group">
            <label for="rotatorSavings">Expected Water Savings (%)</label>
            <input type="number" id="rotatorSavings" value="25" min="20" max="30">
          </div>
        </div>
        
        <div class="upgrade-details" id="soilImprovementsDetails">
          <h3>Soil Improvements</h3>
          <div class="form-group">
            <label for="soilCost">Cost Estimate ($)</label>
            <input type="number" id="soilCost" value="200">
            <p class="help-text">50% rebate up to $100</p>
          </div>
          <div class="form-group">
            <label for="soilDescription">Project Description</label>
            <textarea id="soilDescription" placeholder="Describe soil improvements (e.g., 'Add 2 inches of quality compost to 200 sq ft of vegetable garden beds')"></textarea>
          </div>
        </div>

        <div class="upgrade-details" id="rainwaterHarvestingDetails">
          <h3>Rainwater Harvesting System</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="harvestingType">System Type</label>
              <select id="harvestingType" onchange="updateHarvestingCost()">
                <option value="barrel">Rain Barrel (200-400L)</option>
                <option value="tank1000">Storage Tank (1000L)</option>
                <option value="tank2500">Storage Tank (2500L)</option>
                <option value="tank5000">Large System (5000L+)</option>
              </select>
            </div>
            <div class="form-group">
              <label for="harvestingCost">Installation Cost Estimate ($)</label>
              <input type="number" id="harvestingCost" value="500">
            </div>
          </div>
          <div class="form-group">
            <label for="harvestingSavings">Expected Water Savings (L/year)</label>
            <input type="number" id="harvestingSavings" value="10000">
            <p class="help-text">Based on roof area and annual rainfall</p>
          </div>
          <div class="cost-estimate-box">
            <h4>ğŸ’§ Rainwater Harvesting Benefits</h4>
            <ul style="text-align:left;margin:10px 0;">
              <li>Free water for outdoor irrigation</li>
              <li>Reduce stormwater runoff</li>
              <li>Emergency water supply</li>
              <li>50% rebate up to $750</li>
            </ul>
          </div>
        </div>
        
        <div style="display:flex;justify-content:space-between;margin-top:30px;">
          <button class="btn btn-secondary" onclick="previousStep(3)">â† Back</button>
          <button class="btn btn-success" onclick="calculateSavings()">Calculate My Savings â†’</button>
        </div>
      </div>
    </div>

    <!-- Results Section -->
    <div class="results-section" id="resultsSection">
      <h2>ğŸ‰ Your Water Savings & Rebate Summary</h2>
      
      <div class="primary-results">
        <div class="result-card highlight">
          <div class="card-icon">ğŸ’°</div>
          <div class="result-value" id="totalRebates">$0</div>
          <div class="result-label">Total Rebates Available</div>
        </div>
        <div class="result-card">
          <div class="card-icon">ğŸ’§</div>
          <div class="result-value" id="waterSavings">0 mÂ³</div>
          <div class="result-label">Water Saved per Year</div>
        </div>
        <div class="result-card">
          <div class="card-icon">ğŸŸ</div>
          <div class="result-value" id="peakSavings">0 mÂ³</div>
          <div class="result-label">Peak Salmon Period Savings</div>
        </div>
        <div class="result-card">
          <div class="card-icon">ğŸ’µ</div>
          <div class="result-value" id="trueSavings">$0</div>
          <div class="result-label">True Value Saved/Year</div>
        </div>
      </div>

      <!-- FIXED Email Capture - Now sends structured data directly -->
      <div style="background: linear-gradient(135deg, #4CAF50, #2E7D32); color: white; padding: 30px; border-radius: 10px; margin: 30px 0; text-align: center;">
        <h3 style="margin: 0 0 10px 0; font-size: 24px; color: white;">ğŸ“§ Get Your Results Emailed!</h3>
        <p style="margin: 0 0 20px 0; opacity: 0.95; color: white;">Save your calculation and receive your personalized water savings report</p>
        <div style="display: flex; gap: 10px; max-width: 500px; margin: 0 auto; justify-content: center; align-items: center;">
          <input type="email" id="user-email" placeholder="Enter your email address" style="flex: 1; padding: 12px; border: none; border-radius: 5px; font-size: 16px; color: #333;">
          <button onclick="captureLeadWithResults()" style="padding: 12px 30px; background: white; color: #2E7D32; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; white-space: nowrap;">Save My Results</button>
        </div>
        <div id="webhook-status" style="margin-top: 10px; font-size: 14px; display: none;"></div>
      </div>

      <div class="detailed-breakdown">
        <h3>ğŸ’¡ Your Selected Upgrades</h3>
        <table class="savings-table">
          <thead>
            <tr>
              <th>Upgrade</th>
              <th>Rebate</th>
              <th>Water Saved/Year</th>
              <th>% Reduction</th>
            </tr>
          </thead>
          <tbody id="savingsTableBody"></tbody>
        </table>
      </div>

      <div class="financial-summary" id="financialSummary">
        <p class="summary-text">
          <strong>Annual Bill Savings:</strong> <span id="annualSavings">$0</span><br>
          <strong>True Environmental Value Saved:</strong> <span id="trueValueSaved">$0</span><br>
          <small>Want to see full ROI details? <a href="#" onclick="toggleROI(); return false;">Click here</a></small>
        </p>
        <div id="roiDetails" style="display:none;">
          <table class="roi-table">
            <thead>
              <tr>
                <th>Upgrade</th>
                <th>Cost</th>
                <th>Net Cost</th>
                <th>Payback</th>
                <th>10-Yr Benefit</th>
              </tr>
            </thead>
            <tbody id="roiTableBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Rest of the results section remains the same... -->
      <div class="next-steps">
        <h3>ğŸ“‹ Next Steps</h3>
        <div class="steps-grid">
          <div class="step-card">
            <div class="step-number">1</div>
            <h4>Check Your Email</h4>
            <p>Your personalized report will arrive within 5 minutes</p>
          </div>
          <div class="step-card">
            <div class="step-number">2</div>
            <h4>Get Professional Quote</h4>
            <p>Certified specialist will contact you within 48 hours</p>
          </div>
          <div class="step-card">
            <div class="step-number">3</div>
            <h4>Apply for Rebates</h4>
            <p>We'll help you complete and submit your rebate applications</p>
          </div>
          <div class="step-card">
            <div class="step-number">4</div>
            <h4>Save Water & Money</h4>
            <p>Start saving thousands of litres and dollars every year</p>
          </div>
        </div>
      </div>

      <div class="cta-section">
        <h2>Ready to Start Saving?</h2>
        <p>Download your personalized report or start a new calculation.</p>
        <div style="display:flex;gap:20px;justify-content:center;margin-top:20px;flex-wrap:wrap;">
          <button class="btn btn-primary" id="downloadReport">ğŸ“„ Download Report (PDF)</button>
          <a href="https://rdn.bc.ca/irrigation-upgrades-and-soil-improvements" target="_blank" class="btn btn-secondary">ğŸ“‹ View RDN Programs</a>
          <button class="btn btn-secondary" onclick="location.reload()">ğŸ”„ New Calculation</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div id="successModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999;">
    <div style="position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:white; padding:30px; border-radius:10px; text-align:center; max-width:400px;">
      <h3 style="color:#4CAF50; margin-bottom:15px;">âœ… Success!</h3>
      <p id="successMessage">Your results have been saved! Check your email for your personalized report.</p>
      <button onclick="closeSuccessModal()" style="background:#4CAF50; color:white; border:none; padding:10px 20px; border-radius:5px; cursor:pointer; margin-top:15px;">Close</button>
    </div>
  </div>

  <!-- COMPLETELY FIXED Webhook to send structured data -->
  <script>
  // Store form data globally
  var globalFormData = {};
  var globalSavingsData = {};
  
  // Update global data when calculating savings
  function storeCalculationData() {
    globalFormData = {
      fullName: document.getElementById('fullName')?.value || '',
      email: document.getElementById('email')?.value || '',
      phoneMain: document.getElementById('phoneMain')?.value || '',
      propertyAddress: document.getElementById('propertyAddress')?.value || '',
      city: document.getElementById('city')?.value || '',
      postalCode: document.getElementById('postalCode')?.value || '',
      propertyType: document.getElementById('propertyType')?.value || 'Single Family',
      irrigatedArea: document.getElementById('irrigatedArea')?.value || '0'
    };
    
    globalSavingsData = {
      totalRebates: document.getElementById('totalRebates')?.textContent || '$0',
      waterSavings: document.getElementById('waterSavings')?.textContent || '0 mÂ³',
      peakSavings: document.getElementById('peakSavings')?.textContent || '0 mÂ³',
      trueSavings: document.getElementById('trueSavings')?.textContent || '$0'
    };
  }
  
  // Hook into calculate savings
  window.addEventListener('load', function() {
    const originalCalculateSavings = window.calculateSavings;
    if (originalCalculateSavings) {
      window.calculateSavings = function() {
        originalCalculateSavings();
        setTimeout(storeCalculationData, 500);
      };
    }
  });
  
  function captureLeadWithResults() {
    const emailInput = document.getElementById('user-email');
    const statusDiv = document.getElementById('webhook-status');
    
    if (!emailInput || !emailInput.value) {
      alert('Please enter your email address');
      return;
    }
    
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    if (!emailRegex.test(emailInput.value)) {
      alert('Please enter a valid email address');
      return;
    }
    
    statusDiv.style.display = 'block';
    statusDiv.style.color = 'white';
    statusDiv.textContent = 'Sending your results...';
    
    // Recapture data
    storeCalculationData();
    
    // Build webhook data as structured object (not JSON string)
    const webhookData = {
      Email: emailInput.value,
      Name: globalFormData.fullName || document.getElementById('fullName')?.value || 'Not provided',
      Phone: globalFormData.phoneMain || document.getElementById('phoneMain')?.value || 'Not provided',
      Address: globalFormData.propertyAddress || document.getElementById('propertyAddress')?.value || 'Not provided',
      City: globalFormData.city || document.getElementById('city')?.value || 'Not provided',
      PostalCode: globalFormData.postalCode || document.getElementById('postalCode')?.value || 'Not provided',
      PropertyType: globalFormData.propertyType || document.getElementById('propertyType')?.value || 'Single Family',
      IrrigatedArea: parseInt(globalFormData.irrigatedArea || document.getElementById('irrigatedArea')?.value || '0'),
      TotalRebate: parseInt((globalSavingsData.totalRebates || document.getElementById('totalRebates')?.textContent || '$0').replace(/[$,]/g,'')) || 0,
      WaterSavingsM3: parseFloat((globalSavingsData.waterSavings || document.getElementById('waterSavings')?.textContent || '0').replace(/[^0-9.]/g,'')) || 0,
      AnnualSavings: parseInt((globalSavingsData.trueSavings || document.getElementById('trueSavings')?.textContent || '$0').replace(/[$,]/g,'')) || 0,
      Upgrades: Array.from(document.querySelectorAll('#savingsTableBody tr'))
        .map(row => row.cells[0]?.textContent)
        .filter(text => text && text !== 'TOTALS')
        .join(', ') || 'None selected',
      Timeline: 'ASAP',
      Source: 'RainWise Calculator',
      SubmittedAt: new Date().toISOString()
    };
    
    console.log('Sending structured data:', webhookData);
    
    const WEBHOOK_URL = 'https://hook.us2.make.com/i2jxgrjhi5q1xuzaeewd5xtmdp8k5r5i';
    
    // Send as application/x-www-form-urlencoded instead of JSON
    const formData = new URLSearchParams();
    for (const key in webhookData) {
      formData.append(key, webhookData[key]);
    }
    
    fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: formData.toString(),
      mode: 'no-cors'
    })
    .then(() => {
      console.log('Webhook sent successfully');
      statusDiv.style.color = '#90EE90';
      statusDiv.textContent = 'âœ“ Results sent successfully!';
      showSuccessModal();
      emailInput.value = '';
      
      setTimeout(() => {
        statusDiv.style.display = 'none';
      }, 3000);
    })
    .catch(error => {
      console.error('Webhook error:', error);
      statusDiv.style.color = '#FFB6C1';
      statusDiv.textContent = 'âš ï¸ Error sending results. Please try again.';
    });
  }

  function showSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
      modal.style.display = 'block';
    }
  }

  function closeSuccessModal() {
    const modal = document.getElementById('successModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  console.log('RainWise webhook ready - Form-encoded version');
  </script>

  <script src="rainwise-calculator.js"></script>
</body>
</html>