        const dripUsage = 12.5 * area; // Drip irrigation rate
        results.waterSavings = Math.max(0, baselineUsage - dripUsage) * (months / 12);
        
        // Add savings from water-saving alternatives
        if (consumptionData.length >= 3) {
          results.waterSavings += 12000; // Additional savings from fixtures, native plants, leak fixes, and scheduling
        }
        
        results.costSavings = results.waterSavings * (waterCost / 1000);
        
        // Calculate environmental impact
        results.environmentalImpact = {
          lifetimeWaterSavings: results.waterSavings * 10,
          waterReduction: baselineUsage > 0 ? Math.round(((baselineUsage - dripUsage) / baselineUsage) * 100) : 0,
          equivalentHomes: Math.round(results.waterSavings / 80), // Average daily home usage ~80 gallons
          co2Equivalent: Math.round(results.waterSavings * 0.006) // ~6 lbs CO2 per 1000 gallons water processing
        };
        
        // Calculate rebates for each selected upgrade
        let totalProjectCost = 0;
        
        if (formData.upgrades.includes('drip')) {
          const rebate = calculateDripRebate();
          results.rebateBreakdown['Drip Irrigation Conversion'] = rebate;
          results.totalRebates += rebate;
          totalProjectCost += parseFloat(formData.dripCost) || 0;
        }
        
        if (formData.upgrades.includes('rotators')) {
          const rebate = calculateRotatorRebate();
          results.rebateBreakdown['MP Rotator Nozzles'] = rebate;
          results.totalRebates += rebate;
          totalProjectCost += parseFloat(formData.rotatorCost) || 0;
        }
        
        if (formData.upgrades.includes('controller')) {
          const rebate = calculateControllerRebate();
          results.rebateBreakdown['Smart Controller/Rain Sensor'] = rebate;
          results.totalRebates += rebate;
          totalProjectCost += parseFloat(formData.controllerCost) || 0;
        }
        
        if (formData.upgrades.includes('soil')) {
          const rebate = calculateSoilRebate();
          results.rebateBreakdown['Soil Improvements'] = rebate;
          results.totalRebates += rebate;
          totalProjectCost += parseFloat(formData.materialCost) || 0;
        }
        
        if (formData.upgrades.includes('rainwater')) {
          const rebate = calculateRainwaterRebate();
          results.rebateBreakdown['Rainwater Harvesting'] = rebate;
          results.totalRebates += rebate;
          totalProjectCost += parseFloat(formData.totalRainwaterCost) || 0;
        }
        
        // Check for combo bonus
        if (formData.upgrades.includes('drip') && formData.upgrades.includes('soil')) {
          results.rebateBreakdown['Combo Bonus'] = 100;
          results.totalRebates += 100;
        }
        
        // Calculate payback period
        const netCost = totalProjectCost - results.totalRebates;
        results.paybackPeriod = results.costSavings > 0 ? netCost / results.costSavings : 0;
        
        displayResults(results);
      }
      
      // Collect form data
      function collectFormData() {
        formData.postalCode = document.getElementById('postalCode').value;
        formData.currentIrrigation = document.getElementById('currentIrrigation').value;
        formData.irrigationArea = document.getElementById('irrigationArea').value;
        formData.waterCost = document.getElementById('waterCost').value;
        formData.irrigationMonths = document.getElementById('irrigationMonths').value;
        
        // Collect selected upgrades
        formData.upgrades = Array.from(document.querySelectorAll('input[name="upgrades"]:checked'))
                                .map(cb => cb.value);
        
        // Collect upgrade-specific data
        formData.dripArea = document.getElementById('dripArea').value;
        formData.dripCost = document.getElementById('dripCost').value;
        formData.certifiedPro1 = document.getElementById('certifiedPro1').checked;
        
        formData.headCount = document.getElementById('headCount').value;
        formData.rotatorCost = document.getElementById('rotatorCost').value;
        formData.certifiedPro2 = document.getElementById('certifiedPro2').checked;
        
        formData.controllerType = document.getElementById('controllerType').value;
        formData.controllerCost = document.getElementById('controllerCost').value;
        formData.addRainSensor = document.getElementById('addRainSensor').checked;
        
        formData.materialType = document.getElementById('materialType').value;
        formData.soilArea = document.getElementById('soilArea').value;
        formData.soilDepth = document.getElementById('soilDepth').value;
        formData.materialCost = document.getElementById('materialCost').value;
        
        formData.tankVolume = document.getElementById('tankVolume').value;
        formData.roofArea = document.getElementById('roofArea').value;
        formData.totalRainwaterCost = document.getElementById('totalRainwaterCost').value;
        formData.potableRated = document.getElementById('potableRated').checked;
      }
      
      // Individual rebate calculations
      function calculateDripRebate() {
        if (!formData.certifiedPro1) return 0;
        const cost = parseFloat(formData.dripCost) || 0;
        return Math.min(400, cost * 0.5);
      }
      
      function calculateRotatorRebate() {
        if (!formData.certifiedPro2) return 0;
        return 100; // Fixed rebate amount
      }
      
      function calculateControllerRebate() {
        const cost = parseFloat(formData.controllerCost) || 0;
        if (formData.addRainSensor) {
          return Math.min(100, cost * 0.5);
        } else {
          return Math.min(75, cost * 0.5);
        }
      }
      
      function calculateSoilRebate() {
        const cost = parseFloat(formData.materialCost) || 0;
        return Math.min(100, cost * 0.5);
      }
      
      function calculateRainwaterRebate() {
        const volume = parseFloat(formData.tankVolume) || 0;
        const roofArea = parseFloat(formData.roofArea) || 0;
        const cost = parseFloat(formData.totalRainwaterCost) || 0;
        
        if (volume < 4565 || roofArea < 200 || !formData.potableRated) {
          return 0;
        }
        
        return Math.min(1000, cost * 0.3); // Up to $700 for tank + $300 for other components
      }
      
      // Display results
      function displayResults(results) {
        document.getElementById('waterSavings').textContent = 
          Math.round(results.waterSavings).toLocaleString() + ' gal/year';
        document.getElementById('costSavings').textContent = 
          '$' + Math.round(results.costSavings).toLocaleString();
        document.getElementById('totalRebates').textContent = 
          '$' + Math.round(results.totalRebates).toLocaleString();
        document.getElementById('paybackPeriod').textContent = 
          results.paybackPeriod < 15 ? results.paybackPeriod.toFixed(1) + ' years' : '15+ years';
        
        // Display environmental impact
        document.getElementById('lifetimeWaterSavings').textContent = 
          Math.round(results.environmentalImpact.lifetimeWaterSavings).toLocaleString();
        document.getElementById('waterReduction').textContent = 
          results.environmentalImpact.waterReduction + '%';
        document.getElementById('equivalentHomes').textContent = 
          results.environmentalImpact.equivalentHomes.toLocaleString();
        document.getElementById('co2Equivalent').textContent = 
          results.environmentalImpact.co2Equivalent.toLocaleString();
        
        // Display rebate breakdown
        const breakdownElement = document.getElementById('rebateDetails');
        breakdownElement.innerHTML = '';
        
        Object.entries(results.rebateBreakdown).forEach(([program, amount]) => {
          const div = document.createElement('div');
          div.className = 'rebate-item';
          div.innerHTML = `
            <span>${program}</span>
            <span>$${Math.round(amount).toLocaleString()}</span>
          `;
          breakdownElement.appendChild(div);
        });
        
        // Add total
        const totalDiv = document.createElement('div');
        totalDiv.className = 'rebate-item rebate-total';
        totalDiv.innerHTML = `
          <span>Total Rebates</span>
          <span>$${Math.round(results.totalRebates).toLocaleString()}</span>
        `;
        breakdownElement.appendChild(totalDiv);
        
        // Show results section
        document.getElementById('calculatorSection').style.display = 'none';
        document.getElementById('resultsSection').classList.add('active');
        
        document.getElementById('resultsSection').scrollIntoView({ 
          behavior: 'smooth', 
          block: 'start' 
        });
        
        // Store results for PDF generation
        window.calculationResults = results;
      }
      
      // PDF Generation
      document.getElementById('generatePDF').addEventListener('click', function() {
        generatePDF();
      });
      
      function generatePDF() {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(20);
        doc.text('Your Personal RDN Rebate & Water Conservation Plan', 20, 30);
        
        // Property info
        doc.setFontSize(12);
        doc.text(`Property: ${formData.postalCode}`, 20, 50);
        doc.text(`Current System: ${formData.currentIrrigation}`, 20, 60);
        doc.text(`Area: ${formData.irrigationArea} sq ft`, 20, 70);
        
        // Water consumption analysis if available
        if (consumptionData.length >= 3) {
          doc.setFontSize(14);
          doc.text('Water Consumption Analysis', 20, 90);
          doc.setFontSize(12);
          
          const avgUsage = consumptionData.reduce((sum, d) => sum + d.usage, 0) / consumptionData.length;
          doc.text(`Average bi-monthly usage: ${Math.round(avgUsage).toLocaleString()} gallons`, 20, 105);
          
          if (avgUsage > 15000) {
            doc.text('Your usage is above average - great savings potential!', 20, 115);
          }
        }
        
        // Results summary
        doc.setFontSize(14);
        doc.text('Financial Summary', 20, 135);
        doc.setFontSize(12);
        doc.text(`Annual Water Savings: ${document.getElementById('waterSavings').textContent}`, 20, 150);
        doc.text(`Annual Cost Savings: ${document.getElementById('costSavings').textContent}`, 20, 160);
        doc.text(`Total Available Rebates: ${document.getElementById('totalRebates').textContent}`, 20, 170);
        doc.text(`Complete Payback Period: ${document.getElementById('paybackPeriod').textContent}`, 20, 180);
        
        // Environmental impact
        doc.setFontSize(14);
        doc.text('Environmental Impact (10-Year Projection)', 20, 200);
        doc.setFontSize(12);
        doc.text(`Water Saved: ${document.getElementById('lifetimeWaterSavings').textContent} gallons`, 20, 215);
        doc.text(`Water Use Reduction: ${document.getElementById('waterReduction').textContent}`, 20, 225);
        doc.text(`COâ‚‚ Savings: ${document.getElementById('co2Equivalent').textContent} lbs annually`, 20, 235);
        
        // Add new page for rebate breakdown and next steps
        doc.addPage();
        
        // Rebate breakdown
        doc.setFontSize(14);
        doc.text('Rebate Breakdown', 20, 30);
        let yPos = 45;
        
        Object.entries(window.calculationResults.rebateBreakdown).forEach(([program, amount]) => {
          doc.setFontSize(12);
          doc.text(`${program}: $${Math.round(amount).toLocaleString()}`, 25, yPos);
          yPos += 10;
        });
        
        // Water-saving alternatives
        doc.setFontSize(14);
        doc.text('Additional Water-Saving Recommendations', 20, yPos + 20);
        doc.setFontSize(12);
        yPos += 35;
        
        const alternatives = [
          'Install low-flow fixtures: Save 2,500 gal/year',
          'Replace 30% of lawn with native plants: Save 5,000 gal/year',
          'Fix leaks promptly: Save 3,000 gal/year',
          'Water early morning or evening: Save 1,500 gal/year'
        ];
        
        alternatives.forEach(alt => {
          doc.text(alt, 25, yPos);
          yPos += 10;
        });
        
        // Next steps
        doc.setFontSize(14);
        doc.text('Next Steps', 20, yPos + 20);
        doc.setFontSize(12);
        yPos += 35;
        
        const steps = [
          '1. Apply for RDN pre-approval for eligible rebates',
          '2. Get quotes from IIABC-certified contractors',
          '3. Complete installations with proper documentation',
          '4. Submit rebate applications within 90 days',
          '5. Implement water-saving alternatives',
          '6. Monitor your water bills for ongoing savings!'
        ];
        
        steps.forEach(step => {
          doc.text(step, 25, yPos);
          yPos += 10;
        });
        
        // Footer
        doc.setFontSize(10);
        doc.text('Generated by AI Forester Rainwise Calculator', 20, 280);
        doc.text(`Created: ${new Date().toLocaleDateString()}`, 20, 290);
        
        // Save the PDF
        doc.save('RDN-Water-Conservation-Action-Plan.pdf');
      }
    });
  </script>
</body>
</html>